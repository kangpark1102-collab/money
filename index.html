<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ìš°ë¦¬ì§‘ ìŠ¤ë§ˆíŠ¸ ê°€ê³„ë¶€</title>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- í°íŠ¸ (Pretendard) -->
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    
    <style>
        :root {
            --primary: #6c5ce7;
            --income: #00b894; /* ìˆ˜ì… ìƒ‰ìƒ (ë…¹ìƒ‰) */
            --expense: #6c5ce7; /* ì§€ì¶œ ìƒ‰ìƒ (ë³´ë¼) */
            --bg: #f5f6fa;
            --card-bg: #ffffff;
            --text-main: #2d3436;
            --text-sub: #636e72;
            --border: #dfe6e9;
            --danger: #ff7675;
            --hover-bg: #f1f2f6;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Pretendard', sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            -webkit-font-smoothing: antialiased;
            width: 100%;
            overflow-x: hidden;
        }

        /* ì „ì²´ ë ˆì´ì•„ì›ƒ */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            display: grid;
            grid-template-columns: 380px 1fr;
            gap: 25px;
            box-sizing: border-box;
        }

        /* ìƒë‹¨ ì›” ì„ íƒ */
        .header-bar {
            grid-column: 1 / -1;
            margin-bottom: 10px;
        }
        .month-selector {
            font-size: 1.8rem;
            font-weight: 800;
            color: var(--text-main);
            border: none;
            background: transparent;
            cursor: pointer;
            font-family: 'Pretendard', sans-serif;
            outline: none;
            padding: 0;
        }

        /* ì¹´ë“œ ë°•ìŠ¤ ìŠ¤íƒ€ì¼ */
        .card {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 24px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.03);
            margin-bottom: 20px;
        }

        h3 { font-size: 1.1rem; color: var(--text-sub); margin-top: 0; margin-bottom: 20px; font-weight: 700; }

        /* ëŒ€ì‹œë³´ë“œ (í†µê³„ ë°•ìŠ¤) */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr); /* 3ë“±ë¶„ ê³ ì • */
            gap: 10px;
            margin-bottom: 20px;
            align-items: stretch; /* ë†’ì´ ë™ì¼í•˜ê²Œ ë§ì¶¤ */
        }
        .stat-box {
            background: #fff;
            padding: 15px 5px;
            border-radius: 16px;
            text-align: center;
            border: 1px solid var(--border);
            /* ë‚´ìš© ì •ë ¬ ë° í¬ê¸° ê³ ì • */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 80px;
            overflow: hidden; /* ë‚´ìš© ë„˜ì¹¨ ë°©ì§€ */
        }
        .stat-title { 
            font-size: 0.8rem; 
            color: var(--text-sub); 
            margin-bottom: 5px; 
            white-space: nowrap; /* ì¤„ë°”ê¿ˆ ë°©ì§€ */
        }
        .stat-value { 
            font-size: 1.1rem; 
            font-weight: 800; 
            word-break: break-all;
            line-height: 1.2;
            /* ê¸°ë³¸ ê¸€ì í¬ê¸° */
        }
        
        #total-income { color: var(--income); }
        #total-expense { color: var(--expense); }
        #balance { color: var(--text-main); }

        /* ìˆ˜ì…/ì§€ì¶œ ì „í™˜ íƒ­ */
        .type-tabs {
            display: flex;
            background: #f1f2f6;
            padding: 4px;
            border-radius: 12px;
            margin-bottom: 20px;
        }
        .tab-btn {
            flex: 1;
            padding: 12px;
            border: none;
            background: transparent;
            border-radius: 10px;
            font-weight: 700;
            color: var(--text-sub);
            cursor: pointer;
            transition: all 0.2s;
        }
        .tab-btn.active.expense {
            background: #fff;
            color: var(--expense);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .tab-btn.active.income {
            background: #fff;
            color: var(--income);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        /* ì…ë ¥ í¼ ë””ìì¸ */
        .form-group { margin-bottom: 15px; }
        label { 
            display: block; 
            font-size: 0.85rem; 
            color: var(--text-sub); 
            margin-bottom: 6px; 
            font-weight: 600; 
            margin-left: 2px;
        }
        
        .input-box {
            width: 100%;
            padding: 14px;
            border: 1px solid #ced6e0;
            border-radius: 12px;
            font-size: 1rem;
            box-sizing: border-box;
            background: #fafafa;
            color: var(--text-main);
            font-family: inherit;
            appearance: none;
            -webkit-appearance: none;
            transition: all 0.2s;
        }
        .input-box:focus {
            outline: none;
            border-color: var(--primary);
            background: #fff;
            box-shadow: 0 0 0 3px rgba(108, 92, 231, 0.1);
        }

        .row-group { display: flex; gap: 10px; }
        .col { flex: 1; }

        select.input-box {
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23a4b0be' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 15px center;
            background-size: 16px;
            padding-right: 40px;
        }

        /* ì¹´í…Œê³ ë¦¬ ê·¸ë¦¬ë“œ */
        .category-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }
        .cat-btn {
            padding: 12px;
            border: 1px solid var(--border);
            background: white;
            border-radius: 12px;
            color: var(--text-sub);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
        }
        .cat-btn:hover { background: #f1f2f6; }
        .cat-btn.active {
            color: white;
            border-color: transparent;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        /* ì§€ì¶œìš© í™œì„± ìŠ¤íƒ€ì¼ */
        .expense-mode .cat-btn.active { background: var(--expense); }
        /* ìˆ˜ì…ìš© í™œì„± ìŠ¤íƒ€ì¼ */
        .income-mode .cat-btn.active { background: var(--income); }

        /* ì €ì¥ ë²„íŠ¼ */
        .save-btn {
            width: 100%;
            color: white;
            border: none;
            padding: 18px;
            border-radius: 14px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            margin-top: 20px;
        }
        .expense-mode .save-btn { background: var(--expense); }
        .income-mode .save-btn { background: var(--income); }
        .save-btn:hover { opacity: 0.9; }

        /* í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        .table-container { overflow-x: visible; min-height: 400px; }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        
        th { 
            text-align: left; 
            padding: 15px 10px; 
            color: var(--text-sub); 
            border-bottom: 2px solid var(--border); 
            font-size: 0.9rem; 
            white-space: nowrap; 
            position: relative;
            user-select: none;
            cursor: pointer;
        }
        th:hover { background-color: #fafafa; }
        
        .icon-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-left: 4px;
            font-size: 0.8rem;
            color: #b2bec3;
        }
        
        /* ìˆ˜ì…/ì§€ì¶œ í–‰ ìŠ¤íƒ€ì¼ */
        .expense-row.income-row {
            background-color: rgba(0, 184, 148, 0.08); /* ì—°í•œ ë…¹ìƒ‰ */
        }
        .expense-row.income-row:hover {
            background-color: rgba(0, 184, 148, 0.15);
        }

        td { padding: 18px 10px; border-bottom: 1px solid var(--border); font-size: 0.95rem; vertical-align: middle; }
        .text-right { text-align: right; }
        .tag { display: inline-block; padding: 6px 12px; border-radius: 8px; font-size: 0.85rem; font-weight: 700; }
        
        .delete-btn { 
            background: none; 
            border: none; 
            color: #b2bec3; 
            cursor: pointer; 
            font-size: 1.2rem;
            padding: 8px; /* í„°ì¹˜ ì˜ì—­ í™•ëŒ€ */
        }
        .delete-btn:hover { color: var(--danger); }

        /* Edit ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .edit-btn {
            background: none;
            border: none;
            color: var(--primary);
            cursor: pointer;
            font-size: 0.8rem; /* ì‘ì€ ê¸€ì”¨ */
            font-weight: 700;
            padding: 8px;
            margin-right: 2px;
        }
        .edit-btn:hover {
            text-decoration: underline;
        }

        /* í•„í„° ë“œë¡­ë‹¤ìš´ */
        .filter-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            background: white;
            border: 1px solid var(--border);
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            z-index: 100;
            min-width: 120px;
            padding: 8px 0;
        }
        .filter-dropdown.show { display: block; }
        .filter-item { padding: 10px 16px; font-size: 0.9rem; cursor: pointer; }
        .filter-item:hover { background: var(--bg); }
        .filter-item.selected { font-weight: bold; color: var(--primary); background: #f0f0ff; }

        /* ëª¨ë°”ì¼ ë°˜ì‘í˜• */
        @media (max-width: 768px) {
            .container { grid-template-columns: 1fr; padding: 15px; gap: 15px; }
            .header-bar { margin-bottom: 5px; }
            .left-panel { order: 1; }
            .right-panel { order: 2; }
            
            table, thead, tbody, th, td, tr { display: block; }
            table { width: 100%; min-width: 0; } /* min-width: 600px í•´ì œ */
            thead { display: none; }

            .mobile-filter-bar {
                display: flex;
                gap: 8px;
                margin-bottom: 15px;
                overflow-x: auto;
                padding-bottom: 5px;
            }
            .mobile-filter-btn {
                padding: 8px 14px;
                border: 1px solid var(--border);
                border-radius: 20px;
                background: #fff;
                font-size: 0.85rem;
                white-space: nowrap;
                color: var(--text-sub);
                font-weight: 600;
            }

            .expense-row {
                background: #fff;
                border: 1px solid var(--border);
                border-radius: 16px;
                margin-bottom: 12px;
                padding: 16px;
                position: relative;
                box-shadow: 0 2px 8px rgba(0,0,0,0.02);
            }
            
            td { border: none; padding: 2px 0; display: flex; justify-content: space-between; align-items: center; }
            
            td:nth-of-type(1) { font-size: 0.85rem; color: var(--text-sub); margin-bottom: 8px; order: 1; }
            td:nth-of-type(2) { position: absolute; top: 16px; right: 16px; order: 2; }
            td:nth-of-type(3) { font-size: 1.15rem; font-weight: 700; color: var(--text-main); margin-bottom: 4px; display: block; order: 3; }
            td:nth-of-type(4) {
                font-size: 0.85rem; color: #636e72; background: rgba(0,0,0,0.03);
                display: inline-block; padding: 4px 8px; border-radius: 6px; margin-bottom: 8px; order: 4;
            }
            td:nth-of-type(5) { 
                font-size: 1.25rem; font-weight: 800; color: var(--text-main); 
                display: block; text-align: right; margin-top: 5px; order: 5;
            }
            /* ìˆ˜ì… ê¸ˆì•¡ ìƒ‰ìƒ */
            .income-row td:nth-of-type(5) { color: var(--income); }
            /* ì§€ì¶œ ê¸ˆì•¡ ìƒ‰ìƒ */
            .expense-row:not(.income-row) td:nth-of-type(5) { color: var(--expense); }

            /* ì‚­ì œ/ìˆ˜ì • ë²„íŠ¼ ì˜ì—­ ê°œì„  - ìœ„ì¹˜ ë³€ê²½ë¨ (ì˜¤ë¥¸ìª½ -> ì™¼ìª½ ì•„ë˜) */
            td:nth-of-type(6) { 
                position: absolute; 
                bottom: 12px; 
                left: 16px; /* ì™¼ìª½ìœ¼ë¡œ ì´ë™ */
                right: auto; 
                order: 6; 
                padding: 0;
                display: flex;
                align-items: center;
                gap: 5px; /* ë²„íŠ¼ ì‚¬ì´ ê°„ê²© */
            }
            .delete-btn {
                font-size: 1.5rem; /* í„°ì¹˜í•˜ê¸° ì¢‹ê²Œ í‚¤ì›€ */
                padding: 10px 5px; /* ì¢Œìš° íŒ¨ë”© ì¶•ì†Œ */
                color: #b2bec3;
            }
            .edit-btn {
                font-size: 0.9rem;
                padding: 10px 8px;
            }

            /* ëª¨ë°”ì¼ ëŒ€ì‹œë³´ë“œ í°íŠ¸ ì‚¬ì´ì¦ˆ ì¡°ì • */
            .stat-value {
                /* í™”ë©´ í¬ê¸°ì— ë”°ë¼ ê¸€ì í¬ê¸° ìœ ë™ì  ì¡°ì ˆ */
                font-size: clamp(0.85rem, 4vw, 1.1rem);
            }
            .dashboard-grid {
                gap: 8px;
            }
            .stat-box {
                padding: 12px 2px;
            }
        }
        
        @media (min-width: 769px) {
            .mobile-filter-bar { display: none; }
        }

        /* ìš”ì†Œ ìˆ¨ê¹€ìš© í´ë˜ìŠ¤ */
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div class="container">
        
        <div class="header-bar">
            <input type="month" id="month-picker" class="month-selector">
        </div>

        <div class="left-panel">
            <!-- ëŒ€ì‹œë³´ë“œ (ìˆ˜ì •ë¨: ìˆ˜ì…/ì§€ì¶œ/ì”ì•¡) -->
            <div class="dashboard-grid">
                <div class="stat-box">
                    <div class="stat-title">ì´ ìˆ˜ì…</div>
                    <div class="stat-value" id="total-income">0ì›</div>
                </div>
                <div class="stat-box">
                    <div class="stat-title">ì´ ì§€ì¶œ</div>
                    <div class="stat-value" id="total-expense">0ì›</div>
                </div>
                <div class="stat-box">
                    <div class="stat-title">ì”ì•¡</div>
                    <div class="stat-value" id="balance">0ì›</div>
                </div>
            </div>

            <!-- âœï¸ ì…ë ¥ í¼ -->
            <div class="card" id="record-card">
                <!-- íƒ­ ë²„íŠ¼ -->
                <div class="type-tabs">
                    <button class="tab-btn active expense" onclick="toggleMode('expense')">ì§€ì¶œ</button>
                    <button class="tab-btn income" onclick="toggleMode('income')">ìˆ˜ì…</button>
                </div>
                
                <h3 id="form-title">âœï¸ ì§€ì¶œ ê¸°ë¡í•˜ê¸°</h3>
                
                <div class="form-group">
                    <label>ë‚ ì§œ</label>
                    <input type="date" id="input-date" class="input-box">
                </div>

                <div class="form-group">
                    <label>ë‚´ìš©</label>
                    <input type="text" id="input-merchant" class="input-box" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”">
                </div>

                <div class="row-group">
                    <div class="col form-group">
                        <label>ê¸ˆì•¡</label>
                        <!-- ìˆ˜ì • 1: type="number" ëŒ€ì‹  text ì‚¬ìš©, inputmode="numeric" ì¶”ê°€ -->
                        <input type="text" id="input-amount" class="input-box" placeholder="0" inputmode="numeric">
                    </div>
                    <div class="col form-group">
                        <label id="method-label">ê²°ì œ ìˆ˜ë‹¨</label>
                        
                        <!-- 1. ì§€ì¶œìš©: ë“œë¡­ë‹¤ìš´ -->
                        <select id="input-card" class="input-box">
                            <option value="" disabled selected>ì„ íƒ</option>
                            <option value="ë¯¼ìš°ì‹ ìš©">ë¯¼ìš°ì‹ ìš©</option>
                            <option value="ë¯¼ìš°ì²´í¬">ë¯¼ìš°ì²´í¬</option>
                            <option value="ì†Œì—°ì‹ ìš©">ì†Œì—°ì‹ ìš©</option>
                            <option value="ì†Œì—°ì²´í¬">ì†Œì—°ì²´í¬</option>
                            <option value="ìƒí™œë¹„ì¹´ë“œ">ìƒí™œë¹„ì¹´ë“œ</option>
                            <option value="í˜„ê¸ˆ">í˜„ê¸ˆ</option>
                        </select>
                        
                        <!-- 2. ìˆ˜ì…ìš©: ì¼ë°˜ í…ìŠ¤íŠ¸ ì…ë ¥ (ì´ˆê¸°ì—” ìˆ¨ê¹€) -->
                        <input type="text" id="input-source" class="input-box hidden" placeholder="ì˜ˆ: íšŒì‚¬, ì€í–‰">
                    </div>
                </div>

                <div class="form-group">
                    <label>ì¹´í…Œê³ ë¦¬</label>
                    
                    <!-- ì§€ì¶œ ì¹´í…Œê³ ë¦¬ -->
                    <div class="category-grid" id="expense-cats">
                        <button class="cat-btn" onclick="setCategory('ì‹ë¹„')">ğŸš ì‹ë¹„</button>
                        <button class="cat-btn" onclick="setCategory('ì‡¼í•‘')">ğŸ›ï¸ ì‡¼í•‘</button>
                        <button class="cat-btn" onclick="setCategory('êµí†µ')">ğŸš êµí†µ</button>
                        <button class="cat-btn" onclick="setCategory('ì£¼ê±°')">ğŸ  ì£¼ê±°</button>
                        <button class="cat-btn" onclick="setCategory('ì˜ë£Œ')">ğŸ¥ ì˜ë£Œ</button>
                        <button class="cat-btn" onclick="setCategory('ê¸°íƒ€')">ğŸ¸ ê¸°íƒ€</button>
                    </div>

                    <!-- ìˆ˜ì… ì¹´í…Œê³ ë¦¬ (ì´ˆê¸°ì—” ìˆ¨ê¹€) -->
                    <div class="category-grid hidden" id="income-cats">
                        <button class="cat-btn" onclick="setCategory('ì›”ê¸‰')">ğŸ’° ì›”ê¸‰</button>
                        <button class="cat-btn" onclick="setCategory('íˆ¬ì')">ğŸ“ˆ íˆ¬ì</button>
                        <!-- ìˆ˜ì • 2: í­ì£½(ğŸ‰) ëŒ€ì‹  í¸ì§€ë´‰íˆ¬(âœ‰ï¸)ë¡œ ë³€ê²½ -->
                        <button class="cat-btn" onclick="setCategory('ê²½ì¡°ì‚¬')">âœ‰ï¸ ê²½ì¡°ì‚¬</button>
                        <button class="cat-btn" onclick="setCategory('ê¸°íƒ€')">ğŸ¸ ê¸°íƒ€</button>
                    </div>
                </div>

                <button class="save-btn" onclick="addTransaction()">ê¸°ë¡ ì €ì¥í•˜ê¸°</button>
            </div>

            <!-- ì°¨íŠ¸ -->
            <div class="card">
                <h3>ğŸ“Š ì¹´í…Œê³ ë¦¬ë³„ ë¶„ì„</h3>
                <div style="height: 250px; display: flex; justify-content: center;">
                    <canvas id="expenseChart"></canvas>
                </div>
            </div>
        </div>

        <div class="right-panel">
            <div class="card" style="min-height: 600px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <h3 style="margin:0;">ğŸ“œ ìƒì„¸ ë‚´ì—­</h3>
                </div>

                <div class="mobile-filter-bar">
                    <div class="mobile-filter-btn active" onclick="resetFilters()">ì „ì²´</div>
                    <div class="mobile-filter-btn" onclick="toggleSort('amount')">ğŸ’° ê¸ˆì•¡ìˆœ</div>
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th width="15%" onclick="toggleSort('date')">ë‚ ì§œ <span class="icon-btn" id="icon-date">â–¼</span></th>
                                <th width="15%">ì¹´í…Œê³ ë¦¬</th>
                                <th width="25%">ë‚´ìš©</th>
                                <th width="15%">ê²°ì œ/ì¶œì²˜</th>
                                <th width="20%" class="text-right" onclick="toggleSort('amount')">ê¸ˆì•¡ <span class="icon-btn" id="icon-amount">â‡µ</span></th>
                                <th width="10%"></th>
                            </tr>
                        </thead>
                        <tbody id="expense-list"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK ë° ë¡œì§ -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, deleteDoc, updateDoc, doc } 
        from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCE-XSrGqSApyyEG-KAurUtRc-tVDR8XCI",
            authDomain: "money-aef17.firebaseapp.com",
            projectId: "money-aef17",
            storageBucket: "money-aef17.appspot.com",
            messagingSenderId: "", 
            appId: "" 
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const COLLECTION_NAME = "expenses";

        // ìƒíƒœ ë³€ìˆ˜
        let currentMode = "expense"; // 'expense' or 'income'
        let currentCategory = "";
        let chartInstance = null;
        let allExpenses = []; 
        let editingId = null; // ìˆ˜ì • ì¤‘ì¸ ë¬¸ì„œ ID

        // í•„í„° ë° ì •ë ¬ ìƒíƒœ
        let filterState = { category: 'all', card: 'all' };
        let sortState = { field: 'date', order: 'desc' };
        
        // ì´ˆê¸° ì„¤ì •
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, '0');
        const dd = String(today.getDate()).padStart(2, '0');
        document.getElementById('input-date').value = `${yyyy}-${mm}-${dd}`;
        
        const monthPicker = document.getElementById('month-picker');
        monthPicker.value = `${yyyy}-${mm}`;
        monthPicker.addEventListener('change', () => {
            renderData();
        });

        // --- ê¸ˆì•¡ ì…ë ¥ ì‹œ ìë™ ì‰¼í‘œ(,) ì²˜ë¦¬ ë¡œì§ ---
        const amountInput = document.getElementById('input-amount');
        amountInput.addEventListener('input', function(e) {
            // ì…ë ¥ëœ ê°’ì—ì„œ ìˆ«ìë§Œ ì¶”ì¶œ
            let value = e.target.value.replace(/[^0-9]/g, '');
            if(value) {
                // ìˆ«ìë¥¼ ì²œ ë‹¨ìœ„ ì½¤ë§ˆ í¬ë§·ìœ¼ë¡œ ë³€í™˜í•˜ì—¬ ë‹¤ì‹œ ì…ë ¥ì°½ì— í‘œì‹œ
                e.target.value = Number(value).toLocaleString();
            } else {
                e.target.value = '';
            }
        });
        // ----------------------------------------------------

        // ì „ì—­ í•¨ìˆ˜ ë“±ë¡
        window.renderData = renderData;
        
        // ëª¨ë“œ ì „í™˜ (ì§€ì¶œ <-> ìˆ˜ì…)
        window.toggleMode = (mode) => {
            currentMode = mode;
            currentCategory = ""; // ì¹´í…Œê³ ë¦¬ ì´ˆê¸°í™”
            
            // ëª¨ë“œ ì „í™˜ ì‹œ ìˆ˜ì • ìƒíƒœ ì´ˆê¸°í™” (ì‚¬ìš©ìê°€ ìˆ˜ë™ìœ¼ë¡œ íƒ­ì„ ë°”ê¿¨ì„ ë•Œ)
            editingId = null;
            document.querySelector('.save-btn').innerText = "ê¸°ë¡ ì €ì¥í•˜ê¸°";
            
            const card = document.getElementById('record-card');
            const btns = document.querySelectorAll('.tab-btn');
            const expenseCats = document.getElementById('expense-cats');
            const incomeCats = document.getElementById('income-cats');
            const inputCard = document.getElementById('input-card'); // ë“œë¡­ë‹¤ìš´
            const inputSource = document.getElementById('input-source'); // í…ìŠ¤íŠ¸ì°½
            const methodLabel = document.getElementById('method-label');
            const title = document.getElementById('form-title');

            // ë²„íŠ¼ ìŠ¤íƒ€ì¼
            btns.forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.tab-btn.${mode}`).classList.add('active');

            // ë‚´ìš©ë¬¼ í† ê¸€
            if(mode === 'expense') {
                card.classList.remove('income-mode');
                card.classList.add('expense-mode');
                title.innerText = "âœï¸ ì§€ì¶œ ê¸°ë¡í•˜ê¸°";
                methodLabel.innerText = "ê²°ì œ ìˆ˜ë‹¨";
                
                inputCard.classList.remove('hidden');
                inputSource.classList.add('hidden');
                
                expenseCats.classList.remove('hidden');
                incomeCats.classList.add('hidden');
            } else {
                card.classList.remove('expense-mode');
                card.classList.add('income-mode');
                title.innerText = "ğŸ’° ìˆ˜ì… ê¸°ë¡í•˜ê¸°";
                methodLabel.innerText = "ì…ê¸ˆì²˜";
                
                inputCard.classList.add('hidden');
                inputSource.classList.remove('hidden');
                
                expenseCats.classList.add('hidden');
                incomeCats.classList.remove('hidden');
            }

            // ì¹´í…Œê³ ë¦¬ ì„ íƒ ì´ˆê¸°í™”
            document.querySelectorAll('.cat-btn').forEach(btn => btn.classList.remove('active'));
        }

        window.setCategory = (cat) => {
            currentCategory = cat;
            document.querySelectorAll('.cat-btn').forEach(btn => {
                btn.classList.remove('active');
                if(btn.innerText.includes(cat)) btn.classList.add('active');
            });
        }

        // í†µí•© ì €ì¥ í•¨ìˆ˜ (ì¶”ê°€/ìˆ˜ì •)
        window.addTransaction = async () => {
            const date = document.getElementById('input-date').value;
            const merchant = document.getElementById('input-merchant').value;
            
            // --- ê¸ˆì•¡ ì €ì¥ ì‹œ ì½¤ë§ˆ ì œê±° í›„ ìˆ«ìë¡œ ë³€í™˜ ---
            const rawAmount = document.getElementById('input-amount').value.replace(/,/g, '');
            const amount = Number(rawAmount);
            // ---------------------------------------------------
            
            // ëª¨ë“œì— ë”°ë¼ ê²°ì œìˆ˜ë‹¨/ì…ê¸ˆì²˜ ê°’ ê°€ì ¸ì˜¤ê¸°
            let method = "";
            if(currentMode === 'expense') {
                method = document.getElementById('input-card').value;
            } else {
                method = document.getElementById('input-source').value;
            }

            if(!date || !merchant || !amount || !currentCategory || !method) {
                alert("ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");
                return;
            }

            const btn = document.querySelector('.save-btn');
            const originalBtnText = btn.innerText;
            btn.innerText = "ì €ì¥ ì¤‘...";
            btn.disabled = true;

            try {
                if (editingId) {
                    // ìˆ˜ì • ëª¨ë“œ
                    await updateDoc(doc(db, COLLECTION_NAME, editingId), {
                        type: currentMode,
                        date: date,
                        merchant: merchant,
                        amount: amount,
                        category: currentCategory,
                        card: method
                    });
                    alert("ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
                    editingId = null; // ìˆ˜ì • ëª¨ë“œ í•´ì œ
                    btn.innerText = "ê¸°ë¡ ì €ì¥í•˜ê¸°"; // ë²„íŠ¼ í…ìŠ¤íŠ¸ ë³µêµ¬
                } else {
                    // ì‹ ê·œ ì¶”ê°€
                    await addDoc(collection(db, COLLECTION_NAME), {
                        type: currentMode,
                        date: date,
                        merchant: merchant,
                        amount: amount,
                        category: currentCategory,
                        card: method, 
                        createdAt: new Date().toISOString()
                    });
                }
                
                // ì…ë ¥ì°½ ì´ˆê¸°í™”
                document.getElementById('input-merchant').value = '';
                document.getElementById('input-amount').value = '';
                if(currentMode === 'income') document.getElementById('input-source').value = '';
                
                btn.disabled = false;
                if(!editingId) btn.innerText = "ê¸°ë¡ ì €ì¥í•˜ê¸°";

            } catch (error) {
                console.error("Error:", error);
                alert("ì €ì¥ ì‹¤íŒ¨");
                btn.innerText = originalBtnText;
                btn.disabled = false;
            }
        }

        // ìˆ˜ì • ë²„íŠ¼ í´ë¦­ ì‹œ í˜¸ì¶œ
        window.editItem = (id) => {
            const item = allExpenses.find(i => i.id === id);
            if (!item) return;

            // 1. ëª¨ë“œ ì„¤ì • (ì´ë•Œ editingIdê°€ nullë¡œ ì´ˆê¸°í™”ë˜ë¯€ë¡œ ìˆœì„œ ì¤‘ìš”)
            toggleMode(item.type);

            // 2. ê°’ ì±„ì›Œë„£ê¸°
            document.getElementById('input-date').value = item.date;
            document.getElementById('input-merchant').value = item.merchant;
            document.getElementById('input-amount').value = item.amount.toLocaleString();
            
            // 3. ì¹´í…Œê³ ë¦¬ ì„¤ì •
            setCategory(item.category);

            // 4. ê²°ì œìˆ˜ë‹¨/ì…ê¸ˆì²˜ ì„¤ì •
            if (item.type === 'expense') {
                document.getElementById('input-card').value = item.card;
            } else {
                document.getElementById('input-source').value = item.card;
            }

            // 5. ìˆ˜ì • ëª¨ë“œ í™œì„±í™”
            editingId = id;
            document.querySelector('.save-btn').innerText = "ìˆ˜ì • ì™„ë£Œ";
            
            // 6. í¼ì´ ìˆëŠ” ìƒë‹¨ìœ¼ë¡œ ìŠ¤í¬ë¡¤
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        window.deleteItem = async (id) => {
            if(confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                await deleteDoc(doc(db, COLLECTION_NAME, id));
            }
        }

        // í—¤ë” í•„í„°/ì •ë ¬ í•¨ìˆ˜ë“¤
        window.toggleSort = (field) => {
            if(sortState.field === field) {
                sortState.order = sortState.order === 'desc' ? 'asc' : 'desc';
            } else {
                sortState.field = field;
                sortState.order = 'desc';
            }
            renderData();
        };

        window.resetFilters = () => {
            filterState = { category: 'all', card: 'all' };
            sortState = { field: 'date', order: 'desc' };
            renderData();
        }

        // ë°ì´í„° ë¦¬ìŠ¤ë„ˆ
        const q = query(collection(db, COLLECTION_NAME), orderBy("date", "desc"));
        onSnapshot(q, (snapshot) => {
            allExpenses = [];
            snapshot.forEach((doc) => {
                const data = doc.data();
                if(!data.type) data.type = 'expense';
                if(!data.card) data.card = "ê¸°íƒ€";
                allExpenses.push({ id: doc.id, ...data });
            });
            renderData();
        });

        function renderData() {
            const selectedMonth = monthPicker.value;
            const listBody = document.getElementById('expense-list');
            listBody.innerHTML = "";

            // 1. ì›” í•„í„° (ê¸°ë³¸ê°’)
            let filteredData = allExpenses.filter(item => item.date.startsWith(selectedMonth));

            // 2. ì •ë ¬
            filteredData.sort((a, b) => {
                let valA, valB;
                if(sortState.field === 'amount') {
                    valA = a.amount;
                    valB = b.amount;
                } else {
                    valA = a.date;
                    valB = b.date;
                }

                if(sortState.order === 'desc') return valA > valB ? -1 : 1;
                else return valA > valB ? 1 : -1;
            });

            // UI ìƒíƒœ ì—…ë°ì´íŠ¸
            const sortIcon = sortState.order === 'desc' ? 'â–¼' : 'â–²';
            document.getElementById('icon-date').innerText = sortState.field === 'date' ? sortIcon : 'â–¿';
            document.getElementById('icon-amount').innerText = sortState.field === 'amount' ? sortIcon : 'â‡µ';

            // í†µê³„ ê³„ì‚°
            let totalIncome = 0;
            let totalExpense = 0;
            let categoryStats = {}; 

            if (filteredData.length === 0) {
                listBody.innerHTML = `<div style="padding:40px; text-align:center; color:#b2bec3; grid-column:1/-1;">ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
            }

            filteredData.forEach((data) => {
                if(data.type === 'income') {
                    totalIncome += data.amount;
                } else {
                    totalExpense += data.amount;
                    if (categoryStats[data.category]) categoryStats[data.category] += data.amount;
                    else categoryStats[data.category] = data.amount;
                }

                const formattedDate = data.date.replace(/-/g, '/');
                const rowClass = data.type === 'income' ? 'expense-row income-row' : 'expense-row';
                
                const tr = document.createElement('tr');
                tr.className = rowClass;
                
                // Edit ë²„íŠ¼ ì¶”ê°€
                tr.innerHTML = `
                    <td>${formattedDate}</td>
                    <td><span class="tag" style="background:${getCategoryColor(data.category)}20; color:${getCategoryColor(data.category)}">${data.category}</span></td>
                    <td>${data.merchant}</td>
                    <td>${data.card}</td>
                    <td class="text-right"><strong>${data.amount.toLocaleString()}</strong>ì›</td>
                    <td class="text-right">
                        <button class="edit-btn" onclick="editItem('${data.id}')">Edit</button>
                        <button class="delete-btn" onclick="deleteItem('${data.id}')">&times;</button>
                    </td>
                `;
                listBody.appendChild(tr);
            });

            // ëŒ€ì‹œë³´ë“œ ì—…ë°ì´íŠ¸
            document.getElementById('total-income').innerText = totalIncome.toLocaleString() + "ì›";
            document.getElementById('total-expense').innerText = totalExpense.toLocaleString() + "ì›";
            document.getElementById('balance').innerText = (totalIncome - totalExpense).toLocaleString() + "ì›";

            updateChart(categoryStats);
        }

        function getCategoryColor(cat) {
            switch(cat) {
                /* ì§€ì¶œ */
                case 'ì‹ë¹„': return '#fd79a8';
                case 'ì‡¼í•‘': return '#a29bfe';
                case 'êµí†µ': return '#74b9ff';
                case 'ì£¼ê±°': return '#e17055';
                case 'ì˜ë£Œ': return '#ff7675';
                
                /* ìˆ˜ì… */
                case 'ì›”ê¸‰': return '#00b894';
                case 'íˆ¬ì': return '#0984e3';
                case 'ê²½ì¡°ì‚¬': return '#fab1a0';
                
                default: return '#636e72';
            }
        }

        function updateChart(stats) {
            const ctx = document.getElementById('expenseChart').getContext('2d');
            const labels = Object.keys(stats);
            const data = Object.values(stats);
            const bgColors = labels.map(cat => getCategoryColor(cat));

            if(chartInstance) chartInstance.destroy();

            chartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: bgColors,
                        borderWidth: 0,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { padding: 20, usePointStyle: true, font: { family: 'Pretendard' } } }
                    },
                    cutout: '65%'
                }
            });
        }
        
        // ì´ˆê¸° ì‹¤í–‰ ì‹œ ëª¨ë“œ ì„¤ì • (UI ì´ˆê¸°í™”)
        toggleMode('expense');
    </script>
</body>
</html>
