<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìš°ë¦¬ì§‘ ìŠ¤ë§ˆíŠ¸ ê°€ê³„ë¶€</title>
    <!-- Chart.js (ì°¨íŠ¸ ë¼ì´ë¸ŒëŸ¬ë¦¬) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- í°íŠ¸ ì ìš© (Pretendard) -->
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    
    <style>
        :root {
            --primary: #6c5ce7;
            --primary-light: #a29bfe;
            --bg: #dfe6e9;
            --card-bg: #ffffff;
            --text-main: #2d3436;
            --text-sub: #636e72;
            --danger: #ff7675;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Pretendard', sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            -webkit-font-smoothing: antialiased;
        }

        /* ë ˆì´ì•„ì›ƒ ì»¨í…Œì´ë„ˆ */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            display: grid;
            grid-template-columns: 350px 1fr; /* ì™¼ìª½ ì…ë ¥ì°½, ì˜¤ë¥¸ìª½ ë¦¬ìŠ¤íŠ¸ */
            gap: 20px;
        }

        /* ëª¨ë°”ì¼ ë°˜ì‘í˜• ì²˜ë¦¬ */
        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
                padding: 15px;
            }
        }

        /* ì¹´ë“œ ê³µí†µ ìŠ¤íƒ€ì¼ */
        .card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
        }

        h2, h3 { margin-top: 0; font-weight: 700; color: var(--text-main); }
        h3 { font-size: 1.1rem; color: var(--text-sub); margin-bottom: 15px; }

        /* ìƒë‹¨ ëŒ€ì‹œë³´ë“œ (ìš”ì•½) */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        .stat-box {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 16px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.03);
        }
        .stat-title { font-size: 0.85rem; color: var(--text-sub); margin-bottom: 5px; }
        .stat-value { font-size: 1.25rem; font-weight: 800; color: var(--primary); }

        /* ì…ë ¥ í¼ ìŠ¤íƒ€ì¼ */
        .form-group { margin-bottom: 16px; }
        label { display: block; font-size: 0.85rem; color: var(--text-sub); margin-bottom: 8px; font-weight: 600; }
        input {
            width: 100%;
            padding: 12px;
            border: 2px solid #f1f2f6;
            border-radius: 10px;
            font-size: 1rem;
            box-sizing: border-box;
            transition: border-color 0.2s;
            font-family: inherit;
        }
        input:focus { outline: none; border-color: var(--primary); }

        /* ì¹´í…Œê³ ë¦¬ ë²„íŠ¼ ê·¸ë¦¬ë“œ */
        .category-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }
        .cat-btn {
            padding: 10px;
            border: 2px solid #f1f2f6;
            background: white;
            border-radius: 10px;
            color: var(--text-sub);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }
        .cat-btn:hover { background: #f1f2f6; }
        .cat-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* ì €ì¥ ë²„íŠ¼ */
        .save-btn {
            width: 100%;
            background: var(--primary);
            color: white;
            border: none;
            padding: 16px;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            margin-top: 10px;
            transition: opacity 0.2s;
        }
        .save-btn:hover { opacity: 0.9; }

        /* ë¦¬ìŠ¤íŠ¸ í…Œì´ë¸” */
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 500px; }
        th { text-align: left; padding: 12px; color: var(--text-sub); border-bottom: 2px solid #f1f2f6; font-size: 0.9rem; }
        td { padding: 16px 12px; border-bottom: 1px solid #f1f2f6; font-size: 0.95rem; vertical-align: middle; }
        
        .expense-row:last-child td { border-bottom: none; }
        
        /* íƒœê·¸ ìŠ¤íƒ€ì¼ */
        .tag {
            display: inline-block;
            padding: 6px 10px;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 700;
        }
        
        .delete-btn {
            background: none;
            border: none;
            color: #b2bec3;
            cursor: pointer;
            font-size: 1.2rem;
            padding: 5px;
        }
        .delete-btn:hover { color: var(--danger); }

        /* ìœ í‹¸ë¦¬í‹° */
        .text-right { text-align: right; }
        .chart-container { position: relative; height: 250px; width: 100%; display: flex; justify-content: center; }

    </style>
</head>
<body>

    <div class="container">
        <!-- ëª¨ë°”ì¼ì—ì„œëŠ” ë§¨ ìœ„, PCì—ì„œëŠ” ì™¼ìª½ ì „ì²´ ì˜ì—­ -->
        <div class="left-panel">
            
            <!-- 1. ìš”ì•½ ëŒ€ì‹œë³´ë“œ -->
            <div class="dashboard-grid">
                <div class="stat-box">
                    <div class="stat-title">ì´ë²ˆ ë‹¬ ì§€ì¶œ</div>
                    <div class="stat-value" id="total-amount">0ì›</div>
                </div>
                <div class="stat-box">
                    <div class="stat-title">ì§€ì¶œ ê±´ìˆ˜</div>
                    <div class="stat-value" id="total-count">0ê±´</div>
                </div>
                <div class="stat-box">
                    <div class="stat-title">ìµœë‹¤ ì§€ì¶œ</div>
                    <div class="stat-value" id="top-category">-</div>
                </div>
            </div>

            <!-- 2. ì…ë ¥ í¼ -->
            <div class="card">
                <h2>âœï¸ ì§€ì¶œ ê¸°ë¡í•˜ê¸°</h2>
                <div class="form-group">
                    <label>ë‚ ì§œ</label>
                    <input type="date" id="input-date">
                </div>
                <div class="form-group">
                    <label>ë‚´ìš© (ê°€ë§¹ì )</label>
                    <input type="text" id="input-merchant" placeholder="ì˜ˆ: ìŠ¤íƒ€ë²…ìŠ¤, ì¿ íŒ¡">
                </div>
                <div class="form-group">
                    <label>ê¸ˆì•¡</label>
                    <input type="number" id="input-amount" placeholder="ìˆ«ìë§Œ ì…ë ¥">
                </div>
                <div class="form-group">
                    <label>ì¹´í…Œê³ ë¦¬</label>
                    <div class="category-grid" id="category-wrapper">
                        <button class="cat-btn" onclick="setCategory('ì‹ë¹„')">ğŸš ì‹ë¹„</button>
                        <button class="cat-btn" onclick="setCategory('ì‡¼í•‘')">ğŸ›ï¸ ì‡¼í•‘</button>
                        <button class="cat-btn" onclick="setCategory('êµí†µ')">ğŸš êµí†µ</button>
                        <button class="cat-btn" onclick="setCategory('ì£¼ê±°')">ğŸ  ì£¼ê±°</button>
                        <button class="cat-btn" onclick="setCategory('ì˜ë£Œ')">ğŸ¥ ì˜ë£Œ</button>
                        <button class="cat-btn" onclick="setCategory('ê¸°íƒ€')">ğŸ¸ ê¸°íƒ€</button>
                    </div>
                </div>
                <button class="save-btn" onclick="addExpense()">ì €ì¥í•˜ê¸°</button>
            </div>

            <!-- 3. ì°¨íŠ¸ ì˜ì—­ -->
            <div class="card">
                <h3>ğŸ“Š ì¹´í…Œê³ ë¦¬ë³„ ë¶„ì„</h3>
                <div class="chart-container">
                    <canvas id="expenseChart"></canvas>
                </div>
            </div>
        </div>

        <!-- ì˜¤ë¥¸ìª½ íŒ¨ë„: ë¦¬ìŠ¤íŠ¸ -->
        <div class="right-panel">
            <div class="card" style="min-height: 600px;">
                <h3>ğŸ“œ ì§€ì¶œ ë‚´ì—­ (ìµœì‹ ìˆœ)</h3>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th width="20%">ë‚ ì§œ</th>
                                <th width="15%">ë¶„ë¥˜</th>
                                <th width="35%">ë‚´ìš©</th>
                                <th width="20%" class="text-right">ê¸ˆì•¡</th>
                                <th width="10%"></th>
                            </tr>
                        </thead>
                        <tbody id="expense-list">
                            <!-- JSë¡œ ë°ì´í„°ê°€ ë“¤ì–´ì˜µë‹ˆë‹¤ -->
                            <tr>
                                <td colspan="5" style="text-align:center; padding: 40px; color: #b2bec3;">
                                    ë¡œë”©ì¤‘...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK ë° ë¡œì§ -->
    <script type="module">
        // Firebase ë¼ì´ë¸ŒëŸ¬ë¦¬ (CDN)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, deleteDoc, doc } 
        from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        // ğŸ”´ ì‚¬ìš©ì ì„¤ì • (ì œê³µí•´ì£¼ì‹  í‚¤ ì ìš©ë¨)
        const firebaseConfig = {
            apiKey: "AIzaSyCE-XSrGqSApyyEG-KAurUtRc-tVDR8XCI",
            authDomain: "money-aef17.firebaseapp.com",
            projectId: "money-aef17", // authDomain ê¸°ë°˜ìœ¼ë¡œ ì„¤ì •
            storageBucket: "money-aef17.appspot.com",
            messagingSenderId: "", 
            appId: "" 
        };

        // 1. Firebase ì´ˆê¸°í™”
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const COLLECTION_NAME = "expenses"; // DB ì»¬ë ‰ì…˜ ì´ë¦„

        // ìƒíƒœ ë³€ìˆ˜
        let currentCategory = "";
        let chartInstance = null;

        // ì´ˆê¸° ë‚ ì§œ ì„¤ì • (ì˜¤ëŠ˜)
        document.getElementById('input-date').value = new Date().toISOString().substring(0, 10);

        // 2. ì¹´í…Œê³ ë¦¬ ì„ íƒ í•¨ìˆ˜ (ì „ì—­ ë…¸ì¶œ)
        window.setCategory = (cat) => {
            currentCategory = cat;
            document.querySelectorAll('.cat-btn').forEach(btn => {
                btn.classList.remove('active');
                if(btn.innerText.includes(cat)) btn.classList.add('active');
            });
        }

        // 3. ì§€ì¶œ ì¶”ê°€ í•¨ìˆ˜
        window.addExpense = async () => {
            const date = document.getElementById('input-date').value;
            const merchant = document.getElementById('input-merchant').value;
            const amount = Number(document.getElementById('input-amount').value);

            if(!date || !merchant || !amount || !currentCategory) {
                alert("ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”! (ì¹´í…Œê³ ë¦¬ ì„ íƒ í•„ìˆ˜)");
                return;
            }

            const btn = document.querySelector('.save-btn');
            btn.innerText = "ì €ì¥ ì¤‘...";
            btn.disabled = true;

            try {
                await addDoc(collection(db, COLLECTION_NAME), {
                    date: date,
                    merchant: merchant,
                    amount: amount,
                    category: currentCategory,
                    createdAt: new Date() // ì •ë ¬ìš© íƒ€ì„ìŠ¤íƒ¬í”„
                });
                
                // ì…ë ¥ ì´ˆê¸°í™”
                document.getElementById('input-merchant').value = '';
                document.getElementById('input-amount').value = '';
                // ì¹´í…Œê³ ë¦¬ëŠ” ìœ ì§€í•˜ê±°ë‚˜ ì´ˆê¸°í™” (ì—¬ê¸°ì„  ìœ ì§€)
                btn.innerText = "ì €ì¥í•˜ê¸°";
                btn.disabled = false;
                
            } catch (error) {
                console.error("Error:", error);
                alert("ì €ì¥ ì‹¤íŒ¨! (ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”)");
                btn.innerText = "ì €ì¥í•˜ê¸°";
                btn.disabled = false;
            }
        }

        // 4. ì‚­ì œ í•¨ìˆ˜
        window.deleteItem = async (id) => {
            if(confirm("ì •ë§ ì´ ë‚´ì—­ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                try {
                    await deleteDoc(doc(db, COLLECTION_NAME, id));
                } catch(e) {
                    alert("ì‚­ì œ ì‹¤íŒ¨");
                }
            }
        }

        // 5. ì‹¤ì‹œê°„ ë°ì´í„° ë¦¬ìŠ¤ë„ˆ (í•µì‹¬ ë¡œì§)
        // ğŸ”¥ ìˆ˜ì •ë¨: ë³µí•© ì¸ë±ìŠ¤ ì˜¤ë¥˜ ë°©ì§€ë¥¼ ìœ„í•´ orderBy í•˜ë‚˜ë§Œ ì‚¬ìš©
        const q = query(collection(db, COLLECTION_NAME), orderBy("date", "desc"));
        
        onSnapshot(q, (snapshot) => {
            const listBody = document.getElementById('expense-list');
            listBody.innerHTML = ""; // ì´ˆê¸°í™”

            let total = 0;
            let count = 0;
            let categoryStats = {};
            let expenses = [];

            if (snapshot.empty) {
                listBody.innerHTML = `<tr><td colspan="5" style="text-align:center; padding:40px;">ì•„ì§ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ì²« ì§€ì¶œì„ ê¸°ë¡í•´ë³´ì„¸ìš”!</td></tr>`;
                updateDashboard(0, 0, "-");
                updateChart({});
                return;
            }

            snapshot.forEach((doc) => {
                const data = doc.data();
                expenses.push({ id: doc.id, ...data }); // ë°ì´í„° ìˆ˜ì§‘
            });

            // ğŸ’¡ í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œ ì •ë ¬ (ê°™ì€ ë‚ ì§œë©´ ì…ë ¥ìˆœ/ìµœì‹ ìˆœ ë“±)
            // ì—¬ê¸°ì„œëŠ” ë‹¨ìˆœ ë‚ ì§œ ë‚´ë¦¼ì°¨ìˆœì„ ë”°ë¦…ë‹ˆë‹¤. í•„ìš”ì‹œ ì¶”ê°€ ì •ë ¬ ë¡œì§ ì‚½ì… ê°€ëŠ¥.

            expenses.forEach((data) => {
                // í†µê³„ ëˆ„ì 
                total += data.amount;
                count++;
                if (categoryStats[data.category]) {
                    categoryStats[data.category] += data.amount;
                } else {
                    categoryStats[data.category] = data.amount;
                }

                // ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
                const tr = document.createElement('tr');
                tr.className = "expense-row";
                tr.innerHTML = `
                    <td>${data.date.substring(5)}</td>
                    <td><span class="tag" style="background:${getTagColor(data.category)}20; color:${getTagColor(data.category)}">${data.category}</span></td>
                    <td>${data.merchant}</td>
                    <td class="text-right"><strong>${data.amount.toLocaleString()}</strong>ì›</td>
                    <td class="text-right"><button class="delete-btn" onclick="deleteItem('${data.id}')">&times;</button></td>
                `;
                listBody.appendChild(tr);
            });

            // ìµœë‹¤ ì§€ì¶œ ì¹´í…Œê³ ë¦¬ ê³„ì‚°
            let maxCat = "-";
            let maxVal = 0;
            for(const [cat, val] of Object.entries(categoryStats)) {
                if(val > maxVal) {
                    maxVal = val;
                    maxCat = cat;
                }
            }

            updateDashboard(total, count, maxCat);
            updateChart(categoryStats);
        });

        // UI ì—…ë°ì´íŠ¸ í—¬í¼
        function updateDashboard(total, count, maxCat) {
            document.getElementById('total-amount').innerText = total.toLocaleString() + "ì›";
            document.getElementById('total-count').innerText = count + "ê±´";
            document.getElementById('top-category').innerText = maxCat;
        }

        function getTagColor(cat) {
            switch(cat) {
                case 'ì‹ë¹„': return '#fd79a8';
                case 'ì‡¼í•‘': return '#a29bfe';
                case 'êµí†µ': return '#74b9ff';
                case 'ì£¼ê±°': return '#55efc4';
                case 'ì˜ë£Œ': return '#ff7675';
                default: return '#636e72';
            }
        }

        // ì°¨íŠ¸ ì—…ë°ì´íŠ¸ (Chart.js)
        function updateChart(stats) {
            const ctx = document.getElementById('expenseChart').getContext('2d');
            const labels = Object.keys(stats);
            const data = Object.values(stats);
            
            // ìƒ‰ìƒ ë°°ì—´ ìƒì„±
            const bgColors = labels.map(cat => getTagColor(cat));

            if(chartInstance) {
                chartInstance.destroy();
            }

            chartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: bgColors,
                        borderWidth: 0,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right', labels: { boxWidth: 12, font: { family: 'Pretendard' } } }
                    },
                    cutout: '70%' // ë„ë„› ë‘ê»˜
                }
            });
        }
    </script>
</body>
</html>