<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ìš°ë¦¬ì§‘ ìŠ¤ë§ˆíŠ¸ ê°€ê³„ë¶€</title>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- SheetJS (Excel Library) -->
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <!-- í°íŠ¸ (Pretendard) -->
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    
    <style>
        :root {
            --primary: #6c5ce7;
            --income: #00b894; /* ìˆ˜ì… ìƒ‰ìƒ (ë…¹ìƒ‰) */
            --expense: #6c5ce7; /* ì§€ì¶œ ìƒ‰ìƒ (ë³´ë¼) */
            --bg: #f5f6fa;
            --card-bg: #ffffff;
            --text-main: #2d3436;
            --text-sub: #636e72;
            --border: #dfe6e9;
            --danger: #ff7675;
            --hover-bg: #f1f2f6;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Pretendard', sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            -webkit-font-smoothing: antialiased;
            width: 100%;
            overflow-x: hidden;
        }

        /* ì „ì²´ ë ˆì´ì•„ì›ƒ */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            display: grid;
            grid-template-columns: 380px 1fr;
            gap: 25px;
            box-sizing: border-box;
        }

        /* ìƒë‹¨ í—¤ë” ì˜ì—­ */
        .header-bar {
            grid-column: 1 / -1;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #fff;
            padding: 15px;
            border-radius: 16px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.03);
            flex-wrap: wrap;
            gap: 10px;
        }

        .date-filter-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .date-filter-input {
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-family: 'Pretendard', sans-serif;
            font-size: 1rem;
            color: var(--text-main);
            font-weight: 600;
        }

        /* ë°ì´í„° ê´€ë¦¬ ë²„íŠ¼ (ì—‘ì…€) */
        .data-mgr-btn {
            background-color: #27ae60;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 10px;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.9rem;
            transition: opacity 0.2s;
        }
        .data-mgr-btn:hover { opacity: 0.9; }

        /* ì¹´ë“œ ë°•ìŠ¤ ìŠ¤íƒ€ì¼ */
        .card {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 24px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.03);
            margin-bottom: 20px;
        }

        h3 { font-size: 1.1rem; color: var(--text-sub); margin-top: 0; margin-bottom: 20px; font-weight: 700; }

        /* ëŒ€ì‹œë³´ë“œ (í†µê³„ ë°•ìŠ¤) */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr); /* 3ë“±ë¶„ ê³ ì • */
            gap: 10px;
            margin-bottom: 20px;
            align-items: stretch; /* ë†’ì´ ë™ì¼í•˜ê²Œ ë§ì¶¤ */
        }
        .stat-box {
            background: #fff;
            padding: 15px 5px;
            border-radius: 16px;
            text-align: center;
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 80px;
            overflow: hidden;
        }
        .stat-title { 
            font-size: 0.8rem; 
            color: var(--text-sub); 
            margin-bottom: 5px; 
            white-space: nowrap; 
        }
        .stat-value { 
            font-size: 1.1rem; 
            font-weight: 800; 
            word-break: break-all;
            line-height: 1.2;
        }
        
        #total-income { color: var(--income); }
        #total-expense { color: var(--expense); }
        #balance { color: var(--text-main); }

        /* ìˆ˜ì…/ì§€ì¶œ ì „í™˜ íƒ­ */
        .type-tabs {
            display: flex;
            background: #f1f2f6;
            padding: 4px;
            border-radius: 12px;
            margin-bottom: 20px;
        }
        .tab-btn {
            flex: 1;
            padding: 12px;
            border: none;
            background: transparent;
            border-radius: 10px;
            font-weight: 700;
            color: var(--text-sub);
            cursor: pointer;
            transition: all 0.2s;
        }
        .tab-btn.active.expense {
            background: #fff;
            color: var(--expense);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .tab-btn.active.income {
            background: #fff;
            color: var(--income);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        /* ì…ë ¥ í¼ ë””ìì¸ */
        .form-group { margin-bottom: 15px; }
        label { 
            display: block; 
            font-size: 0.85rem; 
            color: var(--text-sub); 
            margin-bottom: 6px; 
            font-weight: 600; 
            margin-left: 2px;
        }
        
        .input-box {
            width: 100%;
            padding: 14px;
            border: 1px solid #ced6e0;
            border-radius: 12px;
            font-size: 1rem;
            box-sizing: border-box;
            background: #fafafa;
            color: var(--text-main);
            font-family: inherit;
            appearance: none;
            -webkit-appearance: none;
            transition: all 0.2s;
        }
        .input-box:focus {
            outline: none;
            border-color: var(--primary);
            background: #fff;
            box-shadow: 0 0 0 3px rgba(108, 92, 231, 0.1);
        }

        .row-group { display: flex; gap: 10px; }
        .col { flex: 1; }

        select.input-box {
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23a4b0be' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 15px center;
            background-size: 16px;
            padding-right: 40px;
        }

        /* ì¹´í…Œê³ ë¦¬ ê·¸ë¦¬ë“œ */
        .category-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }
        .cat-btn {
            padding: 12px;
            border: 1px solid var(--border);
            background: white;
            border-radius: 12px;
            color: var(--text-sub);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
        }
        .cat-btn:hover { background: #f1f2f6; }
        .cat-btn.active {
            color: white;
            border-color: transparent;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        .expense-mode .cat-btn.active { background: var(--expense); }
        .income-mode .cat-btn.active { background: var(--income); }

        /* ì €ì¥ ë²„íŠ¼ */
        .save-btn {
            width: 100%;
            color: white;
            border: none;
            padding: 18px;
            border-radius: 14px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            margin-top: 20px;
        }
        .expense-mode .save-btn { background: var(--expense); }
        .income-mode .save-btn { background: var(--income); }
        .save-btn:hover { opacity: 0.9; }

        /* í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        .table-container { overflow-x: visible; min-height: 400px; }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        
        th { 
            text-align: left; 
            padding: 15px 10px; 
            color: var(--text-sub); 
            border-bottom: 2px solid var(--border); 
            font-size: 0.9rem; 
            white-space: nowrap; 
            position: relative;
            user-select: none;
            cursor: pointer;
        }
        th:hover { background-color: #fafafa; }
        
        .icon-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-left: 4px;
            font-size: 0.8rem;
            color: #b2bec3;
        }
        
        .expense-row.income-row {
            background-color: rgba(0, 184, 148, 0.08);
        }
        .expense-row.income-row:hover {
            background-color: rgba(0, 184, 148, 0.15);
        }

        td { padding: 18px 10px; border-bottom: 1px solid var(--border); font-size: 0.95rem; vertical-align: middle; }
        .text-right { text-align: right; }
        .tag { display: inline-block; padding: 6px 12px; border-radius: 8px; font-size: 0.85rem; font-weight: 700; }
        
        .delete-btn { 
            background: none; 
            border: none; 
            color: #b2bec3; 
            cursor: pointer; 
            font-size: 1.2rem;
            padding: 8px;
        }
        .delete-btn:hover { color: var(--danger); }

        .edit-btn {
            background: none;
            border: none;
            color: var(--primary);
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 700;
            padding: 8px;
            margin-right: 2px;
        }
        .edit-btn:hover { text-decoration: underline; }

        /* ëª¨ë°”ì¼ ë°˜ì‘í˜• */
        @media (max-width: 768px) {
            .container { grid-template-columns: 1fr; padding: 15px; gap: 15px; }
            .header-bar { 
                flex-direction: column; 
                align-items: stretch; 
                padding: 12px;
            }
            .date-filter-group {
                justify-content: space-between;
                margin-bottom: 10px;
            }
            .date-filter-input {
                width: 45%;
                font-size: 0.9rem;
            }
            .data-mgr-btn {
                justify-content: center;
                width: 100%;
            }

            .left-panel { order: 1; }
            .right-panel { order: 2; }
            
            table, thead, tbody, th, td, tr { display: block; }
            table { width: 100%; min-width: 0; }
            thead { display: none; }

            .mobile-filter-bar {
                display: flex;
                gap: 8px;
                margin-bottom: 15px;
                overflow-x: auto;
                padding-bottom: 5px;
            }
            .mobile-filter-btn {
                padding: 8px 14px;
                border: 1px solid var(--border);
                border-radius: 20px;
                background: #fff;
                font-size: 0.85rem;
                white-space: nowrap;
                color: var(--text-sub);
                font-weight: 600;
            }

            .expense-row {
                background: #fff;
                border: 1px solid var(--border);
                border-radius: 16px;
                margin-bottom: 12px;
                padding: 16px;
                position: relative;
                box-shadow: 0 2px 8px rgba(0,0,0,0.02);
            }
            
            td { border: none; padding: 2px 0; display: flex; justify-content: space-between; align-items: center; }
            
            td:nth-of-type(1) { font-size: 0.85rem; color: var(--text-sub); margin-bottom: 8px; order: 1; }
            td:nth-of-type(2) { position: absolute; top: 16px; right: 16px; order: 2; }
            td:nth-of-type(3) { font-size: 1.15rem; font-weight: 700; color: var(--text-main); margin-bottom: 4px; display: block; order: 3; }
            td:nth-of-type(4) {
                font-size: 0.85rem; color: #636e72; background: rgba(0,0,0,0.03);
                display: inline-block; padding: 4px 8px; border-radius: 6px; margin-bottom: 8px; order: 4;
            }
            td:nth-of-type(5) { 
                font-size: 1.25rem; font-weight: 800; color: var(--text-main); 
                display: block; text-align: right; margin-top: 5px; order: 5;
            }
            .income-row td:nth-of-type(5) { color: var(--income); }
            .expense-row:not(.income-row) td:nth-of-type(5) { color: var(--expense); }

            td:nth-of-type(6) { 
                position: absolute; bottom: 12px; left: 16px; right: auto; order: 6; padding: 0;
                display: flex; align-items: center; gap: 5px; 
            }
            .delete-btn { font-size: 1.5rem; padding: 10px 5px; color: #b2bec3; }
            .edit-btn { font-size: 0.9rem; padding: 10px 8px; }

            .stat-value { font-size: clamp(0.85rem, 4vw, 1.1rem); }
            .dashboard-grid { gap: 8px; }
            .stat-box { padding: 12px 2px; }
        }
        
        @media (min-width: 769px) {
            .mobile-filter-bar { display: none; }
        }

        .hidden { display: none !important; }

        /* --- ëª¨ë‹¬ ìŠ¤íƒ€ì¼ --- */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            position: relative;
        }
        .modal-header {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;
        }
        .modal-title { font-size: 1.25rem; font-weight: 800; }
        .close-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #b2bec3; }
        
        .modal-section { margin-bottom: 25px; border-bottom: 1px solid #f1f2f6; padding-bottom: 20px; }
        .modal-section:last-child { border-bottom: none; padding-bottom: 0; }
        .modal-label { font-size: 0.9rem; font-weight: 700; color: var(--text-main); margin-bottom: 10px; display: block; }
        
        .action-btn {
            width: 100%; padding: 12px; border-radius: 10px; border: none; font-weight: 700; cursor: pointer; font-family: inherit; margin-bottom: 10px;
        }
        .btn-excel { background: #27ae60; color: white; }
    </style>
</head>
<body>

    <div class="container">
        
        <!-- í—¤ë” ì˜ì—­ (ê¸°ê°„ ì„ íƒ í†µí•©) -->
        <div class="header-bar">
            <div class="date-filter-group">
                <input type="date" id="filter-start" class="date-filter-input" title="ì‹œì‘ì¼">
                <span style="font-weight:bold; color:#b2bec3;">~</span>
                <input type="date" id="filter-end" class="date-filter-input" title="ì¢…ë£Œì¼">
            </div>
            
            <!-- ì—‘ì…€ ë°ì´í„° ê´€ë¦¬ ë²„íŠ¼ -->
            <button class="data-mgr-btn" onclick="openDataModal()">
                <span>ğŸ“Š ì—‘ì…€ ê´€ë¦¬</span>
            </button>
        </div>

        <div class="left-panel">
            <!-- ëŒ€ì‹œë³´ë“œ -->
            <div class="dashboard-grid">
                <div class="stat-box">
                    <div class="stat-title">ê¸°ê°„ ìˆ˜ì…</div>
                    <div class="stat-value" id="total-income">0ì›</div>
                </div>
                <div class="stat-box">
                    <div class="stat-title">ê¸°ê°„ ì§€ì¶œ</div>
                    <div class="stat-value" id="total-expense">0ì›</div>
                </div>
                <div class="stat-box">
                    <div class="stat-title">ì”ì•¡</div>
                    <div class="stat-value" id="balance">0ì›</div>
                </div>
            </div>

            <!-- âœï¸ ì…ë ¥ í¼ -->
            <div class="card" id="record-card">
                <!-- íƒ­ ë²„íŠ¼ -->
                <div class="type-tabs">
                    <button class="tab-btn active expense" onclick="toggleMode('expense')">ì§€ì¶œ</button>
                    <button class="tab-btn income" onclick="toggleMode('income')">ìˆ˜ì…</button>
                </div>
                
                <h3 id="form-title">âœï¸ ì§€ì¶œ ê¸°ë¡í•˜ê¸°</h3>
                
                <div class="form-group">
                    <label>ë‚ ì§œ</label>
                    <input type="date" id="input-date" class="input-box">
                </div>

                <div class="form-group">
                    <label>ë‚´ìš©</label>
                    <input type="text" id="input-merchant" class="input-box" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”">
                </div>

                <div class="row-group">
                    <div class="col form-group">
                        <label>ê¸ˆì•¡</label>
                        <input type="text" id="input-amount" class="input-box" placeholder="0" inputmode="numeric">
                    </div>
                    <div class="col form-group">
                        <label id="method-label">ê²°ì œ ìˆ˜ë‹¨</label>
                        
                        <!-- 1. ì§€ì¶œìš©: ë“œë¡­ë‹¤ìš´ -->
                        <select id="input-card" class="input-box">
                            <option value="" disabled selected>ì„ íƒ</option>
                            <option value="ë¯¼ìš°ì‹ ìš©">ë¯¼ìš°ì‹ ìš©</option>
                            <option value="ë¯¼ìš°ì²´í¬">ë¯¼ìš°ì²´í¬</option>
                            <option value="ì†Œì—°ì‹ ìš©">ì†Œì—°ì‹ ìš©</option>
                            <option value="ì†Œì—°ì²´í¬">ì†Œì—°ì²´í¬</option>
                            <option value="ìƒí™œë¹„ì¹´ë“œ">ìƒí™œë¹„ì¹´ë“œ</option>
                            <option value="í˜„ê¸ˆ">í˜„ê¸ˆ</option>
                        </select>
                        
                        <!-- 2. ìˆ˜ì…ìš©: ì¼ë°˜ í…ìŠ¤íŠ¸ ì…ë ¥ (ì´ˆê¸°ì—” ìˆ¨ê¹€) -->
                        <input type="text" id="input-source" class="input-box hidden" placeholder="ì˜ˆ: íšŒì‚¬, ì€í–‰">
                    </div>
                </div>

                <div class="form-group">
                    <label>ì¹´í…Œê³ ë¦¬</label>
                    
                    <!-- ì§€ì¶œ ì¹´í…Œê³ ë¦¬ -->
                    <div class="category-grid" id="expense-cats">
                        <button class="cat-btn" onclick="setCategory('ì‹ë¹„')">ğŸš ì‹ë¹„</button>
                        <button class="cat-btn" onclick="setCategory('ì‡¼í•‘')">ğŸ›ï¸ ì‡¼í•‘</button>
                        <button class="cat-btn" onclick="setCategory('êµí†µ')">ğŸš êµí†µ</button>
                        <button class="cat-btn" onclick="setCategory('ì£¼ê±°')">ğŸ  ì£¼ê±°</button>
                        <button class="cat-btn" onclick="setCategory('ì˜ë£Œ')">ğŸ¥ ì˜ë£Œ</button>
                        <button class="cat-btn" onclick="setCategory('ê¸°íƒ€')">ğŸ¸ ê¸°íƒ€</button>
                    </div>

                    <!-- ìˆ˜ì… ì¹´í…Œê³ ë¦¬ (ì´ˆê¸°ì—” ìˆ¨ê¹€) -->
                    <div class="category-grid hidden" id="income-cats">
                        <button class="cat-btn" onclick="setCategory('ì›”ê¸‰')">ğŸ’° ì›”ê¸‰</button>
                        <button class="cat-btn" onclick="setCategory('íˆ¬ì')">ğŸ“ˆ íˆ¬ì</button>
                        <button class="cat-btn" onclick="setCategory('ê²½ì¡°ì‚¬')">âœ‰ï¸ ê²½ì¡°ì‚¬</button>
                        <button class="cat-btn" onclick="setCategory('ê¸°íƒ€')">ğŸ¸ ê¸°íƒ€</button>
                    </div>
                </div>

                <button class="save-btn" onclick="addTransaction()">ê¸°ë¡ ì €ì¥í•˜ê¸°</button>
            </div>

            <!-- ì°¨íŠ¸ -->
            <div class="card">
                <h3>ğŸ“Š ì¹´í…Œê³ ë¦¬ë³„ ë¶„ì„</h3>
                <div style="height: 250px; display: flex; justify-content: center;">
                    <canvas id="expenseChart"></canvas>
                </div>
            </div>
        </div>

        <div class="right-panel">
            <div class="card" style="min-height: 600px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <h3 style="margin:0;">ğŸ“œ ìƒì„¸ ë‚´ì—­</h3>
                </div>

                <div class="mobile-filter-bar">
                    <div class="mobile-filter-btn active" onclick="resetFilters()">ì „ì²´</div>
                    <div class="mobile-filter-btn" onclick="toggleSort('amount')">ğŸ’° ê¸ˆì•¡ìˆœ</div>
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th width="15%" onclick="toggleSort('date')">ë‚ ì§œ <span class="icon-btn" id="icon-date">â–¼</span></th>
                                <th width="15%">ì¹´í…Œê³ ë¦¬</th>
                                <th width="25%">ë‚´ìš©</th>
                                <th width="15%">ê²°ì œ/ì¶œì²˜</th>
                                <th width="20%" class="text-right" onclick="toggleSort('amount')">ê¸ˆì•¡ <span class="icon-btn" id="icon-amount">â‡µ</span></th>
                                <th width="10%"></th>
                            </tr>
                        </thead>
                        <tbody id="expense-list"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- ë°ì´í„° ê´€ë¦¬ ëª¨ë‹¬ -->
    <div id="dataModal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">ì—‘ì…€ ë°ì´í„° ì„¼í„°</div>
                <button class="close-btn" onclick="closeDataModal()">&times;</button>
            </div>
            
            <!-- 1. ì—‘ì…€ ë‹¤ìš´ë¡œë“œ (ìœ ì¼í•œ ê¸°ëŠ¥) -->
            <div class="modal-section">
                <label class="modal-label">ğŸ“¥ í˜„ì¬ ì¡°íšŒ ëª©ë¡ ë‹¤ìš´ë¡œë“œ</label>
                <p style="font-size:0.85rem; color:#636e72; margin-bottom:15px;">
                    í˜„ì¬ ë©”ì¸ í™”ë©´ì—ì„œ í•„í„°ë§ëœ ê¸°ê°„ì˜ ë‚´ì—­ì„ ì—‘ì…€ë¡œ ì €ì¥í•©ë‹ˆë‹¤.
                </p>
                <button class="action-btn btn-excel" onclick="downloadExcel()">ì—‘ì…€ ë‹¤ìš´ë¡œë“œ (í˜„ì¬ í•„í„°)</button>
            </div>
            <!-- ì—…ë¡œë“œ ì„¹ì…˜ ì œê±°ë¨ -->
        </div>
    </div>

    <!-- Firebase SDK ë° ë¡œì§ -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, deleteDoc, updateDoc, doc } 
        from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCE-XSrGqSApyyEG-KAurUtRc-tVDR8XCI",
            authDomain: "money-aef17.firebaseapp.com",
            projectId: "money-aef17",
            storageBucket: "money-aef17.appspot.com",
            messagingSenderId: "", 
            appId: "" 
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const COLLECTION_NAME = "expenses";

        // ìƒíƒœ ë³€ìˆ˜
        let currentMode = "expense";
        let currentCategory = "";
        let chartInstance = null;
        let allExpenses = []; 
        let editingId = null; 

        // í•„í„° ë° ì •ë ¬ ìƒíƒœ
        let sortState = { field: 'date', order: 'desc' };
        
        // ì´ˆê¸° ì„¤ì • (ë‚ ì§œ)
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, '0');
        const dd = String(today.getDate()).padStart(2, '0');
        const todayStr = `${yyyy}-${mm}-${dd}`;
        const firstDayStr = `${yyyy}-${mm}-01`;
        
        // ì…ë ¥í¼ ë‚ ì§œ ì´ˆê¸°í™”
        document.getElementById('input-date').value = todayStr;
        
        // 1. ê¸°ê°„ í•„í„° ì´ˆê¸°í™” (í—¤ë”) -> ë©”ì¸ ë¦¬ìŠ¤íŠ¸ ì œì–´ìš©
        document.getElementById('filter-start').value = firstDayStr;
        document.getElementById('filter-end').value = todayStr;

        // ë‚ ì§œ ë³€ê²½ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        document.getElementById('filter-start').addEventListener('change', renderData);
        document.getElementById('filter-end').addEventListener('change', renderData);

        // --- ê¸ˆì•¡ ì…ë ¥ ì‹œ ìë™ ì‰¼í‘œ(,) ì²˜ë¦¬ ë¡œì§ ---
        const amountInput = document.getElementById('input-amount');
        amountInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/[^0-9]/g, '');
            if(value) {
                e.target.value = Number(value).toLocaleString();
            } else {
                e.target.value = '';
            }
        });

        // ì „ì—­ í•¨ìˆ˜ ë“±ë¡
        window.renderData = renderData;
        window.openDataModal = () => document.getElementById('dataModal').classList.remove('hidden');
        window.closeDataModal = () => document.getElementById('dataModal').classList.add('hidden');
        

        // ============================================
        // 2. ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ë¡œì§ (í˜„ì¬ í•„í„°ë§ëœ ë°ì´í„° ê¸°ì¤€)
        // ============================================
        window.downloadExcel = () => {
            if (typeof XLSX === 'undefined') {
                alert("ì—‘ì…€ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
                return;
            }

            // renderDataì—ì„œ ì‚¬ìš©ëœ í•„í„° ë‚ ì§œ ê°€ì ¸ì˜¤ê¸°
            const start = document.getElementById('filter-start').value;
            const end = document.getElementById('filter-end').value;

            let filtered = allExpenses.filter(item => item.date >= start && item.date <= end);
            filtered.sort((a, b) => a.date > b.date ? 1 : -1);

            if(filtered.length === 0) {
                alert("ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }

            const excelData = filtered.map(item => ({
                "ë‚ ì§œ": item.date,
                "ì¹´í…Œê³ ë¦¬": item.category,
                "ë‚´ìš©": item.merchant,
                "ê²°ì œ/ì¶œì²˜": item.card,
                "ê¸ˆì•¡": item.amount,
                "êµ¬ë¶„": item.type === 'income' ? 'ìˆ˜ì…' : 'ì§€ì¶œ'
            }));

            const ws = XLSX.utils.json_to_sheet(excelData);
            ws['!cols'] = [{ wch: 12 }, { wch: 10 }, { wch: 30 }, { wch: 15 }, { wch: 15 }, { wch: 8 }];
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "ê°€ê³„ë¶€ ë‚´ì—­");
            
            const fileName = `ê°€ê³„ë¶€_${start}_${end}.xlsx`;
            XLSX.writeFile(wb, fileName);
        }

        // ì—‘ì…€ ì—…ë¡œë“œ ë¡œì§ ì‚­ì œë¨ (ìš”ì²­ ë°˜ì˜)


        // ëª¨ë“œ ì „í™˜
        window.toggleMode = (mode) => {
            currentMode = mode;
            currentCategory = "";
            editingId = null;
            document.querySelector('.save-btn').innerText = "ê¸°ë¡ ì €ì¥í•˜ê¸°";
            
            const card = document.getElementById('record-card');
            const btns = document.querySelectorAll('.tab-btn');
            const expenseCats = document.getElementById('expense-cats');
            const incomeCats = document.getElementById('income-cats');
            const inputCard = document.getElementById('input-card'); 
            const inputSource = document.getElementById('input-source'); 
            const methodLabel = document.getElementById('method-label');
            const title = document.getElementById('form-title');

            btns.forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.tab-btn.${mode}`).classList.add('active');

            if(mode === 'expense') {
                card.classList.remove('income-mode');
                card.classList.add('expense-mode');
                title.innerText = "âœï¸ ì§€ì¶œ ê¸°ë¡í•˜ê¸°";
                methodLabel.innerText = "ê²°ì œ ìˆ˜ë‹¨";
                inputCard.classList.remove('hidden');
                inputSource.classList.add('hidden');
                expenseCats.classList.remove('hidden');
                incomeCats.classList.add('hidden');
            } else {
                card.classList.remove('expense-mode');
                card.classList.add('income-mode');
                title.innerText = "ğŸ’° ìˆ˜ì… ê¸°ë¡í•˜ê¸°";
                methodLabel.innerText = "ì…ê¸ˆì²˜";
                inputCard.classList.add('hidden');
                inputSource.classList.remove('hidden');
                expenseCats.classList.add('hidden');
                incomeCats.classList.remove('hidden');
            }
            document.querySelectorAll('.cat-btn').forEach(btn => btn.classList.remove('active'));
        }

        window.setCategory = (cat) => {
            currentCategory = cat;
            document.querySelectorAll('.cat-btn').forEach(btn => {
                btn.classList.remove('active');
                if(btn.innerText.includes(cat)) btn.classList.add('active');
            });
        }

        // í†µí•© ì €ì¥ í•¨ìˆ˜
        window.addTransaction = async () => {
            const date = document.getElementById('input-date').value;
            const merchant = document.getElementById('input-merchant').value;
            const rawAmount = document.getElementById('input-amount').value.replace(/,/g, '');
            const amount = Number(rawAmount);
            
            let method = "";
            if(currentMode === 'expense') {
                method = document.getElementById('input-card').value;
            } else {
                method = document.getElementById('input-source').value;
            }

            if(!date || !merchant || !amount || !currentCategory || !method) {
                alert("ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");
                return;
            }

            const btn = document.querySelector('.save-btn');
            const originalBtnText = btn.innerText;
            btn.innerText = "ì €ì¥ ì¤‘...";
            btn.disabled = true;

            try {
                if (editingId) {
                    await updateDoc(doc(db, COLLECTION_NAME, editingId), {
                        type: currentMode,
                        date: date,
                        merchant: merchant,
                        amount: amount,
                        category: currentCategory,
                        card: method
                    });
                    alert("ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
                    editingId = null;
                    btn.innerText = "ê¸°ë¡ ì €ì¥í•˜ê¸°";
                } else {
                    await addDoc(collection(db, COLLECTION_NAME), {
                        type: currentMode,
                        date: date,
                        merchant: merchant,
                        amount: amount,
                        category: currentCategory,
                        card: method, 
                        createdAt: new Date().toISOString()
                    });
                }
                
                document.getElementById('input-merchant').value = '';
                document.getElementById('input-amount').value = '';
                if(currentMode === 'income') document.getElementById('input-source').value = '';
                
                btn.disabled = false;
                if(!editingId) btn.innerText = "ê¸°ë¡ ì €ì¥í•˜ê¸°";

            } catch (error) {
                console.error("Error:", error);
                alert("ì €ì¥ ì‹¤íŒ¨");
                btn.innerText = originalBtnText;
                btn.disabled = false;
            }
        }

        window.editItem = (id) => {
            const item = allExpenses.find(i => i.id === id);
            if (!item) return;
            toggleMode(item.type);
            document.getElementById('input-date').value = item.date;
            document.getElementById('input-merchant').value = item.merchant;
            document.getElementById('input-amount').value = item.amount.toLocaleString();
            setCategory(item.category);
            if (item.type === 'expense') {
                document.getElementById('input-card').value = item.card;
            } else {
                document.getElementById('input-source').value = item.card;
            }
            editingId = id;
            document.querySelector('.save-btn').innerText = "ìˆ˜ì • ì™„ë£Œ";
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        window.deleteItem = async (id) => {
            if(confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                await deleteDoc(doc(db, COLLECTION_NAME, id));
            }
        }

        window.toggleSort = (field) => {
            if(sortState.field === field) {
                sortState.order = sortState.order === 'desc' ? 'asc' : 'desc';
            } else {
                sortState.field = field;
                sortState.order = 'desc';
            }
            renderData();
        };

        window.resetFilters = () => {
            // í•„í„° ì´ˆê¸°í™”: ë‚ ì§œëŠ” ì´ë²ˆë‹¬ 1ì¼~ì˜¤ëŠ˜ë¡œ ë¦¬ì…‹
            document.getElementById('filter-start').value = firstDayStr;
            document.getElementById('filter-end').value = todayStr;
            sortState = { field: 'date', order: 'desc' };
            renderData();
        }

        // ë°ì´í„° ë¦¬ìŠ¤ë„ˆ
        const q = query(collection(db, COLLECTION_NAME), orderBy("date", "desc"));
        onSnapshot(q, (snapshot) => {
            allExpenses = [];
            snapshot.forEach((doc) => {
                const data = doc.data();
                if(!data.type) data.type = 'expense';
                if(!data.card) data.card = "ê¸°íƒ€";
                allExpenses.push({ id: doc.id, ...data });
            });
            renderData();
        });

        function renderData() {
            // í—¤ë”ì˜ ë‚ ì§œ í•„í„° ê°’ ê°€ì ¸ì˜¤ê¸°
            const startDate = document.getElementById('filter-start').value;
            const endDate = document.getElementById('filter-end').value;
            
            const listBody = document.getElementById('expense-list');
            listBody.innerHTML = "";

            // 1. ê¸°ê°„ í•„í„°ë§ ì ìš©
            let filteredData = allExpenses.filter(item => {
                return item.date >= startDate && item.date <= endDate;
            });

            // 2. ì •ë ¬
            filteredData.sort((a, b) => {
                let valA, valB;
                if(sortState.field === 'amount') {
                    valA = a.amount;
                    valB = b.amount;
                } else {
                    valA = a.date;
                    valB = b.date;
                }

                if(sortState.order === 'desc') return valA > valB ? -1 : 1;
                else return valA > valB ? 1 : -1;
            });

            // UI ìƒíƒœ ì—…ë°ì´íŠ¸
            const sortIcon = sortState.order === 'desc' ? 'â–¼' : 'â–²';
            document.getElementById('icon-date').innerText = sortState.field === 'date' ? sortIcon : 'â–¿';
            document.getElementById('icon-amount').innerText = sortState.field === 'amount' ? sortIcon : 'â‡µ';

            // í†µê³„ ê³„ì‚°
            let totalIncome = 0;
            let totalExpense = 0;
            let categoryStats = {}; 

            if (filteredData.length === 0) {
                listBody.innerHTML = `<div style="padding:40px; text-align:center; color:#b2bec3; grid-column:1/-1;">í•´ë‹¹ ê¸°ê°„ì— ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
            }

            filteredData.forEach((data) => {
                if(data.type === 'income') {
                    totalIncome += data.amount;
                } else {
                    totalExpense += data.amount;
                    if (categoryStats[data.category]) categoryStats[data.category] += data.amount;
                    else categoryStats[data.category] = data.amount;
                }

                const formattedDate = data.date.replace(/-/g, '/');
                const rowClass = data.type === 'income' ? 'expense-row income-row' : 'expense-row';
                
                const tr = document.createElement('tr');
                tr.className = rowClass;
                
                tr.innerHTML = `
                    <td>${formattedDate}</td>
                    <td><span class="tag" style="background:${getCategoryColor(data.category)}20; color:${getCategoryColor(data.category)}">${data.category}</span></td>
                    <td>${data.merchant}</td>
                    <td>${data.card}</td>
                    <td class="text-right"><strong>${data.amount.toLocaleString()}</strong>ì›</td>
                    <td class="text-right">
                        <button class="edit-btn" onclick="editItem('${data.id}')">Edit</button>
                        <button class="delete-btn" onclick="deleteItem('${data.id}')">&times;</button>
                    </td>
                `;
                listBody.appendChild(tr);
            });

            // ëŒ€ì‹œë³´ë“œ ì—…ë°ì´íŠ¸ (ì„ íƒëœ ê¸°ê°„ì˜ í†µê³„ë¡œ ë³€ê²½ë¨)
            document.getElementById('total-income').innerText = totalIncome.toLocaleString() + "ì›";
            document.getElementById('total-expense').innerText = totalExpense.toLocaleString() + "ì›";
            document.getElementById('balance').innerText = (totalIncome - totalExpense).toLocaleString() + "ì›";

            updateChart(categoryStats);
        }

        function getCategoryColor(cat) {
            switch(cat) {
                /* ì§€ì¶œ */
                case 'ì‹ë¹„': return '#fd79a8';
                case 'ì‡¼í•‘': return '#a29bfe';
                case 'êµí†µ': return '#74b9ff';
                case 'ì£¼ê±°': return '#e17055';
                case 'ì˜ë£Œ': return '#ff7675';
                
                /* ìˆ˜ì… */
                case 'ì›”ê¸‰': return '#00b894';
                case 'íˆ¬ì': return '#0984e3';
                case 'ê²½ì¡°ì‚¬': return '#fab1a0';
                
                default: return '#636e72';
            }
        }

        function updateChart(stats) {
            const ctx = document.getElementById('expenseChart').getContext('2d');
            const labels = Object.keys(stats);
            const data = Object.values(stats);
            const bgColors = labels.map(cat => getCategoryColor(cat));

            if(chartInstance) chartInstance.destroy();

            chartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: bgColors,
                        borderWidth: 0,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { padding: 20, usePointStyle: true, font: { family: 'Pretendard' } } }
                    },
                    cutout: '65%'
                }
            });
        }
        
        toggleMode('expense');
    </script>
</body>
</html>
