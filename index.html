<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ìš°ë¦¬ì§‘ ìŠ¤ë§ˆíŠ¸ ê°€ê³„ë¶€</title>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- í°íŠ¸ (Pretendard) -->
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    
    <style>
        :root {
            --primary: #6c5ce7;
            --bg: #f5f6fa;
            --card-bg: #ffffff;
            --text-main: #2d3436;
            --text-sub: #636e72;
            --border: #dfe6e9;
            --danger: #ff7675;
            --hover-bg: #f1f2f6;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Pretendard', sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            -webkit-font-smoothing: antialiased;
            /* ê°€ë¡œ ìŠ¤í¬ë¡¤ ë°©ì§€ ì•ˆì „ì¥ì¹˜ */
            width: 100%;
            overflow-x: hidden;
        }

        /* ì „ì²´ ë ˆì´ì•„ì›ƒ */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            display: grid;
            grid-template-columns: 380px 1fr;
            gap: 25px;
            box-sizing: border-box; /* íŒ¨ë”© í¬í•¨ í¬ê¸° ê³„ì‚° */
        }

        /* ìƒë‹¨ ì›” ì„ íƒ */
        .header-bar {
            grid-column: 1 / -1;
            margin-bottom: 10px;
        }
        .month-selector {
            font-size: 1.8rem;
            font-weight: 800;
            color: var(--text-main);
            border: none;
            background: transparent;
            cursor: pointer;
            font-family: 'Pretendard', sans-serif;
            outline: none;
            padding: 0;
        }

        /* ì¹´ë“œ ë°•ìŠ¤ ìŠ¤íƒ€ì¼ */
        .card {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 24px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.03);
            margin-bottom: 20px;
        }

        h3 { font-size: 1.1rem; color: var(--text-sub); margin-top: 0; margin-bottom: 20px; font-weight: 700; }

        /* ëŒ€ì‹œë³´ë“œ */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }
        .stat-box {
            background: #fff;
            padding: 15px;
            border-radius: 16px;
            text-align: center;
            border: 1px solid var(--border);
        }
        .stat-title { font-size: 0.8rem; color: var(--text-sub); margin-bottom: 5px; }
        .stat-value { font-size: 1.1rem; font-weight: 800; color: var(--primary); word-break: keep-all; }

        /* ì…ë ¥ í¼ ë””ìì¸ (ë°•ìŠ¤ ìŠ¤íƒ€ì¼) */
        .form-group { margin-bottom: 15px; }
        label { 
            display: block; 
            font-size: 0.85rem; 
            color: var(--text-sub); 
            margin-bottom: 6px; 
            font-weight: 600; 
            margin-left: 2px;
        }
        
        /* ì…ë ¥ì°½ ê³µí†µ ìŠ¤íƒ€ì¼ */
        .input-box {
            width: 100%;
            padding: 14px;
            border: 1px solid #ced6e0;
            border-radius: 12px;
            font-size: 1rem;
            box-sizing: border-box;
            background: #fafafa;
            color: var(--text-main);
            font-family: inherit;
            appearance: none;
            -webkit-appearance: none;
            transition: all 0.2s;
        }
        .input-box:focus {
            outline: none;
            border-color: var(--primary);
            background: #fff;
            box-shadow: 0 0 0 3px rgba(108, 92, 231, 0.1);
        }

        /* ê¸ˆì•¡ê³¼ ê²°ì œìˆ˜ë‹¨ì„ í•œ ì¤„ì— ë°°ì¹˜í•˜ê¸° ìœ„í•œ Flex */
        .row-group {
            display: flex;
            gap: 10px;
        }
        .col { flex: 1; }

        /* ì…€ë ‰íŠ¸ ë°•ìŠ¤ í™”ì‚´í‘œ ì»¤ìŠ¤í…€ */
        select.input-box {
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23a4b0be' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 15px center;
            background-size: 16px;
            padding-right: 40px;
        }

        /* ì¹´í…Œê³ ë¦¬ ë²„íŠ¼ ê·¸ë¦¬ë“œ */
        .category-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }
        .cat-btn {
            padding: 12px;
            border: 1px solid var(--border);
            background: white;
            border-radius: 12px;
            color: var(--text-sub);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
        }
        .cat-btn:hover { background: #f1f2f6; }
        .cat-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            box-shadow: 0 4px 10px rgba(108, 92, 231, 0.2);
        }

        /* ì €ì¥ ë²„íŠ¼ */
        .save-btn {
            width: 100%;
            background: var(--primary);
            color: white;
            border: none;
            padding: 18px;
            border-radius: 14px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            margin-top: 20px;
        }
        .save-btn:hover { opacity: 0.9; }

        /* --------------------------------------------------------
           í…Œì´ë¸” ë° í—¤ë” í•„í„° ìŠ¤íƒ€ì¼
        -------------------------------------------------------- */
        .table-container { overflow-x: visible; min-height: 400px; } /* ë“œë¡­ë‹¤ìš´ ì˜ë¦¼ ë°©ì§€ */
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        
        /* í—¤ë” ìŠ¤íƒ€ì¼ */
        th { 
            text-align: left; 
            padding: 15px 10px; 
            color: var(--text-sub); 
            border-bottom: 2px solid var(--border); 
            font-size: 0.9rem; 
            white-space: nowrap; 
            position: relative; /* ë“œë¡­ë‹¤ìš´ ìœ„ì¹˜ ê¸°ì¤€ */
            user-select: none;
            cursor: pointer;
        }
        th:hover { background-color: #fafafa; color: var(--primary); }
        
        /* ì •ë ¬/í•„í„° ì•„ì´ì½˜ */
        .icon-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-left: 4px;
            font-size: 0.8rem;
            color: #b2bec3;
            transition: color 0.2s;
        }
        th:hover .icon-btn { color: var(--primary); }
        .active-filter { color: var(--primary) !important; font-weight: bold; }

        /* í•„í„° ë“œë¡­ë‹¤ìš´ ë©”ë‰´ */
        .filter-dropdown {
            display: none; /* ê¸°ë³¸ ìˆ¨ê¹€ */
            position: absolute;
            top: 100%;
            left: 0;
            background: white;
            border: 1px solid var(--border);
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            z-index: 100;
            min-width: 120px;
            padding: 8px 0;
        }
        .filter-dropdown.show { display: block; }
        
        .filter-item {
            padding: 10px 16px;
            font-size: 0.9rem;
            color: var(--text-main);
            cursor: pointer;
            transition: background 0.1s;
        }
        .filter-item:hover { background: var(--bg); color: var(--primary); }
        .filter-item.selected { font-weight: bold; color: var(--primary); background: #f0f0ff; }

        td { padding: 18px 10px; border-bottom: 1px solid var(--border); font-size: 0.95rem; vertical-align: middle; }
        .text-right { text-align: right; }
        .tag { display: inline-block; padding: 6px 12px; border-radius: 8px; font-size: 0.85rem; font-weight: 700; }
        .delete-btn { background: none; border: none; color: #b2bec3; cursor: pointer; font-size: 1.2rem; }

        /* ğŸ“± ëª¨ë°”ì¼ ë°˜ì‘í˜• */
        @media (max-width: 768px) {
            .container { grid-template-columns: 1fr; padding: 15px; gap: 15px; }
            .header-bar { margin-bottom: 5px; }
            .left-panel { order: 1; }
            .right-panel { order: 2; }
            
            /* ëª¨ë°”ì¼ì—ì„œ í…Œì´ë¸” ìŠ¤íƒ€ì¼ ì¬ì„¤ì • (ê°€ë¡œìŠ¤í¬ë¡¤ ë°©ì§€ í•µì‹¬) */
            table, thead, tbody, th, td, tr { display: block; }
            table { min-width: auto; width: 100%; } /* min-width í•´ì œ */
            thead { display: none; } /* í—¤ë” ìˆ¨ê¹€ */

            /* ëª¨ë°”ì¼ ì „ìš© í•„í„°/ì •ë ¬ ë²„íŠ¼ ì˜ì—­ */
            .mobile-filter-bar {
                display: flex;
                gap: 8px;
                margin-bottom: 15px;
                overflow-x: auto;
                padding-bottom: 5px;
            }
            .mobile-filter-btn {
                padding: 8px 14px;
                border: 1px solid var(--border);
                border-radius: 20px;
                background: #fff;
                font-size: 0.85rem;
                white-space: nowrap;
                color: var(--text-sub);
                font-weight: 600;
            }
            .mobile-filter-btn.active {
                background: var(--primary);
                color: white;
                border-color: var(--primary);
            }

            /* ëª¨ë°”ì¼ ë¦¬ìŠ¤íŠ¸ ì¹´ë“œ ìŠ¤íƒ€ì¼ */
            .expense-row {
                background: #fff;
                border: 1px solid var(--border);
                border-radius: 16px;
                margin-bottom: 12px;
                padding: 16px;
                position: relative;
                box-shadow: 0 2px 8px rgba(0,0,0,0.02);
            }
            
            td { border: none; padding: 2px 0; display: flex; justify-content: space-between; align-items: center; }
            
            /* 1. ë‚ ì§œ & ì¹´í…Œê³ ë¦¬ */
            td:nth-of-type(1) { font-size: 0.85rem; color: var(--text-sub); margin-bottom: 8px; order: 1; } /* ë‚ ì§œ */
            td:nth-of-type(2) { position: absolute; top: 16px; right: 16px; order: 2; } /* ì¹´í…Œê³ ë¦¬ ë°°ì§€ */
            
            /* 2. ë‚´ìš© (ê°€ë§¹ì ) */
            td:nth-of-type(3) { 
                font-size: 1.15rem; 
                font-weight: 700; 
                color: var(--text-main); 
                margin-bottom: 4px; 
                display: block; 
                order: 3;
            }

            /* 3. ê²°ì œìˆ˜ë‹¨ (ë³„ë„ ì¤„ë¡œ í‘œì‹œ) */
            td:nth-of-type(4) {
                font-size: 0.85rem;
                color: #636e72;
                background: #f5f6fa;
                display: inline-block;
                padding: 4px 8px;
                border-radius: 6px;
                margin-bottom: 8px;
                order: 4;
            }

            /* 4. ê¸ˆì•¡ */
            td:nth-of-type(5) { 
                font-size: 1.25rem; 
                font-weight: 800; 
                color: var(--primary); 
                display: block; 
                text-align: right; 
                margin-top: 5px;
                order: 5;
            }
            
            /* 5. ì‚­ì œ ë²„íŠ¼ */
            td:nth-of-type(6) { position: absolute; bottom: 16px; right: 16px; order: 6; }
        }
        
        /* PCì—ì„œ ëª¨ë°”ì¼ë°” ìˆ¨ê¹€ */
        @media (min-width: 769px) {
            .mobile-filter-bar { display: none; }
        }
    </style>
</head>
<body>

    <div class="container">
        
        <div class="header-bar">
            <input type="month" id="month-picker" class="month-selector">
        </div>

        <div class="left-panel">
            <!-- ëŒ€ì‹œë³´ë“œ -->
            <div class="dashboard-grid">
                <div class="stat-box">
                    <div class="stat-title">ì´ ì§€ì¶œ</div>
                    <div class="stat-value" id="total-amount">0ì›</div>
                </div>
                <div class="stat-box">
                    <div class="stat-title">ê±´ìˆ˜</div>
                    <div class="stat-value" id="total-count">0ê±´</div>
                </div>
                <div class="stat-box">
                    <div class="stat-title">ìµœë‹¤ ì§€ì¶œ</div>
                    <div class="stat-value" id="top-category" style="font-size: 0.9rem;">-</div>
                </div>
            </div>

            <!-- âœï¸ ì…ë ¥ í¼ -->
            <div class="card">
                <h3>âœï¸ ì§€ì¶œ ê¸°ë¡í•˜ê¸°</h3>
                
                <div class="form-group">
                    <label>ë‚ ì§œ</label>
                    <input type="date" id="input-date" class="input-box">
                </div>

                <div class="form-group">
                    <label>ë‚´ìš© (ì‚¬ìš©ì²˜)</label>
                    <input type="text" id="input-merchant" class="input-box" placeholder="ì˜ˆ: ì½”ìŠ¤íŠ¸ì½” ì¥ë³´ê¸°">
                </div>

                <div class="row-group">
                    <div class="col form-group">
                        <label>ê¸ˆì•¡</label>
                        <input type="number" id="input-amount" class="input-box" placeholder="0">
                    </div>
                    <div class="col form-group">
                        <label>ê²°ì œ ìˆ˜ë‹¨</label>
                        <select id="input-card" class="input-box">
                            <option value="" disabled selected>ì„ íƒ</option>
                            <option value="ë¯¼ìš°ì‹ ìš©">ë¯¼ìš°ì‹ ìš©</option>
                            <option value="ë¯¼ìš°ì²´í¬">ë¯¼ìš°ì²´í¬</option>
                            <option value="ì†Œì—°ì‹ ìš©">ì†Œì—°ì‹ ìš©</option>
                            <option value="ì†Œì—°ì²´í¬">ì†Œì—°ì²´í¬</option>
                            <option value="ìƒí™œë¹„ì¹´ë“œ">ìƒí™œë¹„ì¹´ë“œ</option>
                            <option value="í˜„ê¸ˆ">í˜„ê¸ˆ</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label>ì¹´í…Œê³ ë¦¬</label>
                    <div class="category-grid">
                        <button class="cat-btn" onclick="setCategory('ì‹ë¹„')">ğŸš ì‹ë¹„</button>
                        <button class="cat-btn" onclick="setCategory('ì‡¼í•‘')">ğŸ›ï¸ ì‡¼í•‘</button>
                        <button class="cat-btn" onclick="setCategory('êµí†µ')">ğŸš êµí†µ</button>
                        <button class="cat-btn" onclick="setCategory('ì£¼ê±°')">ğŸ  ì£¼ê±°</button>
                        <button class="cat-btn" onclick="setCategory('ì˜ë£Œ')">ğŸ¥ ì˜ë£Œ</button>
                        <button class="cat-btn" onclick="setCategory('ê¸°íƒ€')">ğŸ¸ ê¸°íƒ€</button>
                    </div>
                </div>

                <button class="save-btn" onclick="addExpense()">ê¸°ë¡ ì €ì¥í•˜ê¸°</button>
            </div>

            <!-- ì°¨íŠ¸ -->
            <div class="card">
                <h3>ğŸ“Š ì¹´í…Œê³ ë¦¬ë³„ ë¶„ì„</h3>
                <div style="height: 250px; display: flex; justify-content: center;">
                    <canvas id="expenseChart"></canvas>
                </div>
            </div>
        </div>

        <div class="right-panel">
            <div class="card" style="min-height: 600px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <h3 style="margin:0;">ğŸ“œ ì§€ì¶œ ìƒì„¸ ë‚´ì—­</h3>
                </div>

                <!-- ëª¨ë°”ì¼ ì „ìš© í•„í„° ë°” (PCì—ì„œëŠ” ì•ˆë³´ì„) -->
                <div class="mobile-filter-bar">
                    <div class="mobile-filter-btn active" onclick="resetFilters()">ì „ì²´</div>
                    <div class="mobile-filter-btn" onclick="toggleSort('amount')">ğŸ’° ê¸ˆì•¡ìˆœ</div>
                    <div class="mobile-filter-btn" onclick="alert('PC í™”ë©´ì—ì„œ ìƒì„¸ í•„í„° ê¸°ëŠ¥ì„ ì´ìš©í•´ì£¼ì„¸ìš”.')">ğŸ” ìƒì„¸í•„í„°</div>
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <!-- ë‚ ì§œ (ì •ë ¬) -->
                                <th width="15%" onclick="toggleSort('date')">
                                    ë‚ ì§œ <span class="icon-btn" id="icon-date">â–¼</span>
                                </th>
                                
                                <!-- ì¹´í…Œê³ ë¦¬ (í•„í„°) -->
                                <th width="15%" onclick="toggleDropdown('filter-cat', event)">
                                    ì¹´í…Œê³ ë¦¬ <span class="icon-btn" id="icon-cat">â–¾</span>
                                    <div id="filter-cat" class="filter-dropdown">
                                        <div class="filter-item selected" onclick="applyFilter('category', 'all')">ì „ì²´</div>
                                        <div class="filter-item" onclick="applyFilter('category', 'ì‹ë¹„')">ì‹ë¹„</div>
                                        <div class="filter-item" onclick="applyFilter('category', 'ì‡¼í•‘')">ì‡¼í•‘</div>
                                        <div class="filter-item" onclick="applyFilter('category', 'êµí†µ')">êµí†µ</div>
                                        <div class="filter-item" onclick="applyFilter('category', 'ì£¼ê±°')">ì£¼ê±°</div>
                                        <div class="filter-item" onclick="applyFilter('category', 'ì˜ë£Œ')">ì˜ë£Œ</div>
                                        <div class="filter-item" onclick="applyFilter('category', 'ê¸°íƒ€')">ê¸°íƒ€</div>
                                    </div>
                                </th>
                                
                                <!-- ë‚´ìš© (ë‹¨ìˆœ í…ìŠ¤íŠ¸) -->
                                <th width="25%">ë‚´ìš©</th>
                                
                                <!-- ê²°ì œìˆ˜ë‹¨ (í•„í„°) -->
                                <th width="15%" onclick="toggleDropdown('filter-method', event)">
                                    ê²°ì œìˆ˜ë‹¨ <span class="icon-btn" id="icon-method">â–¾</span>
                                    <div id="filter-method" class="filter-dropdown">
                                        <div class="filter-item selected" onclick="applyFilter('card', 'all')">ì „ì²´</div>
                                        <div class="filter-item" onclick="applyFilter('card', 'ë¯¼ìš°ì‹ ìš©')">ë¯¼ìš°ì‹ ìš©</div>
                                        <div class="filter-item" onclick="applyFilter('card', 'ë¯¼ìš°ì²´í¬')">ë¯¼ìš°ì²´í¬</div>
                                        <div class="filter-item" onclick="applyFilter('card', 'ì†Œì—°ì‹ ìš©')">ì†Œì—°ì‹ ìš©</div>
                                        <div class="filter-item" onclick="applyFilter('card', 'ì†Œì—°ì²´í¬')">ì†Œì—°ì²´í¬</div>
                                        <div class="filter-item" onclick="applyFilter('card', 'ìƒí™œë¹„ì¹´ë“œ')">ìƒí™œë¹„ì¹´ë“œ</div>
                                        <div class="filter-item" onclick="applyFilter('card', 'í˜„ê¸ˆ')">í˜„ê¸ˆ</div>
                                    </div>
                                </th>
                                
                                <!-- ê¸ˆì•¡ (ì •ë ¬) -->
                                <th width="20%" class="text-right" onclick="toggleSort('amount')">
                                    ê¸ˆì•¡ <span class="icon-btn" id="icon-amount">â‡µ</span>
                                </th>
                                
                                <th width="10%"></th>
                            </tr>
                        </thead>
                        <tbody id="expense-list"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK ë° ë¡œì§ -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, deleteDoc, doc } 
        from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        // ì‚¬ìš©ì ì„¤ì •
        const firebaseConfig = {
            apiKey: "AIzaSyCE-XSrGqSApyyEG-KAurUtRc-tVDR8XCI",
            authDomain: "money-aef17.firebaseapp.com",
            projectId: "money-aef17",
            storageBucket: "money-aef17.appspot.com",
            messagingSenderId: "", 
            appId: "" 
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const COLLECTION_NAME = "expenses";

        // ìƒíƒœ ë³€ìˆ˜
        let currentCategory = "";
        let chartInstance = null;
        let allExpenses = []; 

        // í•„í„° ë° ì •ë ¬ ìƒíƒœ
        let filterState = { category: 'all', card: 'all' };
        let sortState = { field: 'date', order: 'desc' }; // date, amount

        // ì´ˆê¸° ë‚ ì§œ ì„¤ì •
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, '0');
        const dd = String(today.getDate()).padStart(2, '0');
        document.getElementById('input-date').value = `${yyyy}-${mm}-${dd}`;
        
        const monthPicker = document.getElementById('month-picker');
        monthPicker.value = `${yyyy}-${mm}`;
        monthPicker.addEventListener('change', renderData);
        
        // ì „ì—­ í•¨ìˆ˜ ë“±ë¡
        window.renderData = renderData;
        window.setCategory = (cat) => {
            currentCategory = cat;
            document.querySelectorAll('.cat-btn').forEach(btn => {
                btn.classList.remove('active');
                if(btn.innerText.includes(cat)) btn.classList.add('active');
            });
        }

        // í—¤ë” í´ë¦­ ì´ë²¤íŠ¸ í•¨ìˆ˜ë“¤
        window.toggleDropdown = (id, event) => {
            event.stopPropagation(); // ë²„ë¸”ë§ ë°©ì§€
            // ë‹¤ë¥¸ ë“œë¡­ë‹¤ìš´ ë‹«ê¸°
            document.querySelectorAll('.filter-dropdown').forEach(el => {
                if(el.id !== id) el.classList.remove('show');
            });
            document.getElementById(id).classList.toggle('show');
        };

        // í™”ë©´ ì•„ë¬´ë°ë‚˜ ëˆ„ë¥´ë©´ ë“œë¡­ë‹¤ìš´ ë‹«ê¸°
        window.addEventListener('click', () => {
            document.querySelectorAll('.filter-dropdown').forEach(el => el.classList.remove('show'));
        });

        window.applyFilter = (type, value) => {
            if(type === 'category') filterState.category = value;
            if(type === 'card') filterState.card = value;
            renderData();
        };

        window.toggleSort = (field) => {
            if(sortState.field === field) {
                // ê°™ì€ í•„ë“œë©´ ìˆœì„œ ë°˜ì „
                sortState.order = sortState.order === 'desc' ? 'asc' : 'desc';
            } else {
                // ë‹¤ë¥¸ í•„ë“œë©´ í•´ë‹¹ í•„ë“œ ë‚´ë¦¼ì°¨ìˆœìœ¼ë¡œ ì‹œì‘
                sortState.field = field;
                sortState.order = 'desc';
            }
            renderData();
        };

        window.resetFilters = () => {
            filterState = { category: 'all', card: 'all' };
            sortState = { field: 'date', order: 'desc' };
            renderData();
        }

        // ì €ì¥ í•¨ìˆ˜
        window.addExpense = async () => {
            const date = document.getElementById('input-date').value;
            const merchant = document.getElementById('input-merchant').value;
            const amount = Number(document.getElementById('input-amount').value);
            const cardSelect = document.getElementById('input-card');
            const currentCard = cardSelect.value; 

            if(!date || !merchant || !amount || !currentCategory || currentCard === "") {
                alert("ë‚´ìš©, ê¸ˆì•¡, ì¹´ë“œ, ì¹´í…Œê³ ë¦¬ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”!");
                return;
            }

            const btn = document.querySelector('.save-btn');
            btn.innerText = "ì €ì¥ ì¤‘...";
            btn.disabled = true;

            try {
                await addDoc(collection(db, COLLECTION_NAME), {
                    date: date,
                    merchant: merchant,
                    amount: amount,
                    category: currentCategory,
                    card: currentCard,
                    createdAt: new Date().toISOString()
                });
                
                document.getElementById('input-merchant').value = '';
                document.getElementById('input-amount').value = '';
                btn.innerText = "ê¸°ë¡ ì €ì¥í•˜ê¸°";
                btn.disabled = false;
                
            } catch (error) {
                console.error("Error:", error);
                alert("ì €ì¥ ì‹¤íŒ¨");
                btn.innerText = "ê¸°ë¡ ì €ì¥í•˜ê¸°";
                btn.disabled = false;
            }
        }

        window.deleteItem = async (id) => {
            if(confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                await deleteDoc(doc(db, COLLECTION_NAME, id));
            }
        }

        // ë°ì´í„° ë¦¬ìŠ¤ë„ˆ
        const q = query(collection(db, COLLECTION_NAME), orderBy("date", "desc"));
        onSnapshot(q, (snapshot) => {
            allExpenses = [];
            snapshot.forEach((doc) => {
                const data = doc.data();
                if(!data.card) data.card = "ê¸°íƒ€";
                allExpenses.push({ id: doc.id, ...data });
            });
            renderData();
        });

        // ë Œë”ë§ í•¨ìˆ˜
        function renderData() {
            const selectedMonth = monthPicker.value;
            const listBody = document.getElementById('expense-list');
            listBody.innerHTML = "";

            // 1. ì›” í•„í„°
            let filteredData = allExpenses.filter(item => item.date.startsWith(selectedMonth));

            // 2. ì¹´í…Œê³ ë¦¬ í•„í„°
            if(filterState.category !== 'all') {
                filteredData = filteredData.filter(item => item.category === filterState.category);
            }

            // 3. ì¹´ë“œ í•„í„°
            if(filterState.card !== 'all') {
                filteredData = filteredData.filter(item => item.card === filterState.card);
            }

            // 4. ì •ë ¬
            filteredData.sort((a, b) => {
                let valA, valB;
                if(sortState.field === 'amount') {
                    valA = a.amount;
                    valB = b.amount;
                } else {
                    valA = a.date;
                    valB = b.date;
                }

                if(sortState.order === 'desc') return valA > valB ? -1 : 1;
                else return valA > valB ? 1 : -1;
            });

            // ì•„ì´ì½˜ ë° UI ìƒíƒœ ì—…ë°ì´íŠ¸
            updateHeaderUI();

            // í†µê³„ ê³„ì‚°
            let total = 0;
            let count = 0;
            let categoryStats = {};

            if (filteredData.length === 0) {
                listBody.innerHTML = `<div style="padding:40px; text-align:center; color:#b2bec3; grid-column:1/-1;">ì¡°ê±´ì— ë§ëŠ” ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
            }

            filteredData.forEach((data) => {
                total += data.amount;
                count++;
                
                if (categoryStats[data.category]) categoryStats[data.category] += data.amount;
                else categoryStats[data.category] = data.amount;

                const formattedDate = data.date.replace(/-/g, '/');

                const tr = document.createElement('tr');
                tr.className = "expense-row";
                
                // ê²°ì œìˆ˜ë‹¨ ë³„ë„ í•­ëª©ìœ¼ë¡œ ë¶„ë¦¬ (4ë²ˆì§¸ td)
                tr.innerHTML = `
                    <td>${formattedDate}</td>
                    <td><span class="tag" style="background:${getCategoryColor(data.category)}20; color:${getCategoryColor(data.category)}">${data.category}</span></td>
                    <td>${data.merchant}</td>
                    <td>${data.card}</td>
                    <td class="text-right"><strong>${data.amount.toLocaleString()}</strong>ì›</td>
                    <td class="text-right"><button class="delete-btn" onclick="deleteItem('${data.id}')">&times;</button></td>
                `;
                listBody.appendChild(tr);
            });

            let maxCat = "-";
            let maxVal = 0;
            for(const [cat, val] of Object.entries(categoryStats)) {
                if(val > maxVal) { maxVal = val; maxCat = cat; }
            }

            document.getElementById('total-amount').innerText = total.toLocaleString() + "ì›";
            document.getElementById('total-count').innerText = count + "ê±´";
            document.getElementById('top-category').innerText = maxCat;

            updateChart(categoryStats);
        }

        function updateHeaderUI() {
            // í•„í„° ì•„ì´ì½˜ í™œì„±í™” ìƒíƒœ
            document.getElementById('icon-cat').className = filterState.category !== 'all' ? 'icon-btn active-filter' : 'icon-btn';
            document.getElementById('icon-method').className = filterState.card !== 'all' ? 'icon-btn active-filter' : 'icon-btn';
            
            // ì •ë ¬ ì•„ì´ì½˜ ì—…ë°ì´íŠ¸
            const sortIcon = sortState.order === 'desc' ? 'â–¼' : 'â–²';
            document.getElementById('icon-date').innerText = sortState.field === 'date' ? sortIcon : 'â–¿';
            document.getElementById('icon-amount').innerText = sortState.field === 'amount' ? sortIcon : 'â‡µ';

            // ë“œë¡­ë‹¤ìš´ ì„ íƒ í‘œì‹œ
            updateDropdownSelection('filter-cat', filterState.category);
            updateDropdownSelection('filter-method', filterState.card);
        }

        function updateDropdownSelection(id, value) {
            const container = document.getElementById(id);
            container.querySelectorAll('.filter-item').forEach(el => {
                el.classList.remove('selected');
                // í…ìŠ¤íŠ¸ ë§¤ì¹­ìœ¼ë¡œ ì„ íƒ í‘œì‹œ (ê°„ë‹¨ êµ¬í˜„)
                if((value === 'all' && el.innerText === 'ì „ì²´') || el.innerText === value) {
                    el.classList.add('selected');
                }
            });
        }

        function getCategoryColor(cat) {
            switch(cat) {
                case 'ì‹ë¹„': return '#fd79a8';
                case 'ì‡¼í•‘': return '#a29bfe';
                case 'êµí†µ': return '#74b9ff';
                case 'ì£¼ê±°': return '#00b894';
                case 'ì˜ë£Œ': return '#ff7675';
                default: return '#636e72';
            }
        }

        function updateChart(stats) {
            const ctx = document.getElementById('expenseChart').getContext('2d');
            const labels = Object.keys(stats);
            const data = Object.values(stats);
            const bgColors = labels.map(cat => getCategoryColor(cat));

            if(chartInstance) chartInstance.destroy();

            chartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: bgColors,
                        borderWidth: 0,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { padding: 20, usePointStyle: true, font: { family: 'Pretendard' } } }
                    },
                    cutout: '65%'
                }
            });
        }
    </script>
</body>
</html>
